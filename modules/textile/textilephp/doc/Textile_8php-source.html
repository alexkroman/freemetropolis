<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>TextilePHP: Textile.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a></div>
<h1>Textile.php</h1><a href="Textile_8php.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 &lt;?php
00002 <span class="comment">// @(#) $Id: Textile_8php-source.html,v 1.1.2.2 2004/07/28 16:08:42 jhriggs Exp $</span>
00003 
00004 <span class="comment">/* This program is free software; you can redistribute it and/or modify</span>
00005 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
00006 <span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
00007 <span class="comment"> * (at your option) any later version.</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00012 <span class="comment"> * GNU General Public License for more details.</span>
00013 <span class="comment"> *</span>
00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
00015 <span class="comment"> * along with this program; if not, write to the Free Software</span>
00016 <span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307  USA</span>
00017 <span class="comment"> */</span>
00018 
<a name="l00030"></a><a class="code" href="classTextile.html">00030</a> <span class="keyword">class </span><a class="code" href="classTextile.html">Textile</a> {
<a name="l00037"></a><a class="code" href="classTextile.html#r0">00037</a>   var <a class="code" href="classTextile.html#r0">$options</a> = array();
00038 
<a name="l00046"></a><a class="code" href="classTextile.html#r1">00046</a>   var <a class="code" href="classTextile.html#r1">$urlre</a>;
00047 
<a name="l00055"></a><a class="code" href="classTextile.html#r2">00055</a>   var <a class="code" href="classTextile.html#r2">$punct</a>;
00056 
<a name="l00064"></a><a class="code" href="classTextile.html#r3">00064</a>   var <a class="code" href="classTextile.html#r3">$valignre</a>;
00065 
<a name="l00073"></a><a class="code" href="classTextile.html#r4">00073</a>   var <a class="code" href="classTextile.html#r4">$tblalignre</a>;
00074 
<a name="l00082"></a><a class="code" href="classTextile.html#r5">00082</a>   var <a class="code" href="classTextile.html#r5">$halignre</a>;
00083 
<a name="l00091"></a><a class="code" href="classTextile.html#r6">00091</a>   var <a class="code" href="classTextile.html#r6">$alignre</a>;
00092 
<a name="l00100"></a><a class="code" href="classTextile.html#r7">00100</a>   var <a class="code" href="classTextile.html#r7">$imgalignre</a>;
00101 
<a name="l00109"></a><a class="code" href="classTextile.html#r8">00109</a>   var <a class="code" href="classTextile.html#r8">$clstypadre</a>;
00110 
<a name="l00118"></a><a class="code" href="classTextile.html#r9">00118</a>   var <a class="code" href="classTextile.html#r9">$clstyre</a>;
00119 
<a name="l00127"></a><a class="code" href="classTextile.html#r10">00127</a>   var <a class="code" href="classTextile.html#r10">$clstyfiltre</a>;
00128 
<a name="l00136"></a><a class="code" href="classTextile.html#r11">00136</a>   var <a class="code" href="classTextile.html#r11">$codere</a>;
00137 
<a name="l00145"></a><a class="code" href="classTextile.html#r12">00145</a>   var <a class="code" href="classTextile.html#r12">$blocktags</a>;
00146 
<a name="l00152"></a><a class="code" href="classTextile.html#r13">00152</a>   var <a class="code" href="classTextile.html#r13">$links</a> = array();
00153 
<a name="l00165"></a><a class="code" href="classTextile.html#r14">00165</a>   var <a class="code" href="classTextile.html#r14">$repl</a> = array();
00166 
<a name="l00173"></a><a class="code" href="classTextile.html#r15">00173</a>   var <a class="code" href="classTextile.html#r15">$tmp</a> = array();
00174 
<a name="l00186"></a><a class="code" href="classTextile.html#a0">00186</a>   function <a class="code" href="classTextile.html">Textile</a>($options = array()) {
00187     $this-&gt;options = <a class="code" href="classTextile.html#r0">$options</a>;
00188     $this-&gt;options['<a class="code" href="classTextile.html#a12">filters</a>'] = ($this-&gt;options['<a class="code" href="classTextile.html#a12">filters</a>'] ? $this-&gt;options['<a class="code" href="classTextile.html#a12">filters</a>'] : array());
00189     $this-&gt;options['<a class="code" href="classTextile.html#a7">charset</a>'] = ($this-&gt;options['<a class="code" href="classTextile.html#a7">charset</a>'] ? $this-&gt;options['<a class="code" href="classTextile.html#a7">charset</a>'] : 'iso-8859-1');
00190     $this-&gt;options['<a class="code" href="classTextile.html#a13">char_encoding</a>'] = ($this-&gt;options['<a class="code" href="classTextile.html#a13">char_encoding</a>'] ? $this-&gt;options['<a class="code" href="classTextile.html#a13">char_encoding</a>'] : 1);
00191     $this-&gt;options['do_quotes'] = ($this-&gt;options['do_quotes'] ? $this-&gt;options['do_quotes'] : 1);
00192     $this-&gt;options['<a class="code" href="classTextile.html#a9">trim_spaces</a>'] = ($this-&gt;options['<a class="code" href="classTextile.html#a9">trim_spaces</a>'] ? $this-&gt;options['<a class="code" href="classTextile.html#a9">trim_spaces</a>'] : 0);
00193     $this-&gt;options['smarty_mode'] = ($this-&gt;options['smarty_mode'] ? $this-&gt;options['smarty_mode'] : 1);
00194     $this-&gt;options['<a class="code" href="classTextile.html#a11">preserve_spaces</a>'] = ($this-&gt;options['<a class="code" href="classTextile.html#a11">preserve_spaces</a>'] ? $this-&gt;options['preserve_spaaces'] : 0);
00195     $this-&gt;options['<a class="code" href="classTextile.html#a4">head_offset</a>'] = ($this-&gt;options['<a class="code" href="classTextile.html#a4">head_offset</a>'] ? $this-&gt;options['<a class="code" href="classTextile.html#a4">head_offset</a>'] : 0);
00196 
00197     <span class="keywordflow">if</span> (is_array($this-&gt;options['<a class="code" href="classTextile.html#a6">css</a>'])) {
00198       $this-&gt;<a class="code" href="classTextile.html#a6">css</a>($this-&gt;options['<a class="code" href="classTextile.html#a6">css</a>']);
00199     }
00200     $this-&gt;options['macros'] = ($this-&gt;options['macros'] ? $this-&gt;options['macros'] : $this-&gt;<a class="code" href="classTextile.html#d25">default_macros</a>());
00201     <span class="keywordflow">if</span> ($this-&gt;options['<a class="code" href="classTextile.html#a5">flavor</a>']) {
00202       $this-&gt;<a class="code" href="classTextile.html#a5">flavor</a>($this-&gt;options['<a class="code" href="classTextile.html#a5">flavor</a>']);
00203     } <span class="keywordflow">else</span> {
00204       $this-&gt;<a class="code" href="classTextile.html#a5">flavor</a>('xhtml1/<a class="code" href="classTextile.html#a6">css</a>');
00205     }
00206     $this-&gt;<a class="code" href="classTextile.html#d0">_create_re</a>();
00207   } <span class="comment">// function Textile</span>
00208 
00209   <span class="comment">// getter/setter methods...</span>
00210 
<a name="l00221"></a><a class="code" href="classTextile.html#a1">00221</a>   function <a class="code" href="classTextile.html#a1">set</a>($opt, $value = NULL) {
00222     <span class="keywordflow">if</span> (is_array($opt)) {
00223       foreach ($opt as $opt =&gt; $value) {
00224         $this-&gt;set($opt, $value);
00225       }
00226     } <span class="keywordflow">else</span> {
00227       <span class="comment">// the following options have special set methods</span>
00228       <span class="comment">// that activate upon setting:</span>
00229       <span class="keywordflow">if</span> ($opt == '<a class="code" href="classTextile.html#a7">charset</a>') {
00230         $this-&gt;<a class="code" href="classTextile.html#a7">charset</a>($value);
00231       } elseif ($opt == '<a class="code" href="classTextile.html#a6">css</a>') {
00232         $this-&gt;css($value);
00233       } elseif ($opt == '<a class="code" href="classTextile.html#a5">flavor</a>') {
00234         $this-&gt;flavor($value);
00235       } <span class="keywordflow">else</span> {
00236         $this-&gt;options[$opt] = $value;
00237       }
00238     }
00239   } <span class="comment">// function set</span>
00240 
<a name="l00251"></a><a class="code" href="classTextile.html#a2">00251</a>   function <a class="code" href="classTextile.html#a2">get</a>($opt) {
00252     <span class="keywordflow">return</span> $this-&gt;options[$opt];
00253   } <span class="comment">// function get</span>
00254 
<a name="l00269"></a><a class="code" href="classTextile.html#a3">00269</a>   function <a class="code" href="classTextile.html#a3">disable_html</a>($disable_html = NULL) {
00270     <span class="keywordflow">if</span> ($disable_html != NULL) {
00271       $this-&gt;options['disable_html'] = $disable_html;
00272     }
00273     <span class="keywordflow">return</span> ($this-&gt;options['disable_html'] ? $this-&gt;options['disable_html'] : 0);
00274   } <span class="comment">// function disable_html</span>
00275 
<a name="l00290"></a><a class="code" href="classTextile.html#a4">00290</a>   function <a class="code" href="classTextile.html#a4">head_offset</a>($head_offset = NULL) {
00291     <span class="keywordflow">if</span> ($head_offset != NULL) {
00292       $this-&gt;options['head_offset'] = $head_offset;
00293     }
00294     <span class="keywordflow">return</span> ($this-&gt;options['head_offset'] ? $this-&gt;options['head_offset'] : 0);
00295   } <span class="comment">// function head_offset</span>
00296 
<a name="l00313"></a><a class="code" href="classTextile.html#a5">00313</a>   function <a class="code" href="classTextile.html#a5">flavor</a>($flavor = NULL) {
00314     <span class="keywordflow">if</span> ($flavor != NULL) {
00315       $this-&gt;options['flavor'] = $flavor;
00316       <span class="keywordflow">if</span> (preg_match('/^xhtml(\d)?(\D|$)/', $flavor, $matches)) {
00317         <span class="keywordflow">if</span> ($matches[1] == <span class="charliteral">'2'</span>) {
00318           $this-&gt;options['_line_open'] = '&lt;l&gt;';
00319           $this-&gt;options['_line_close'] = '&lt;/l&gt;';
00320           $this-&gt;options['_blockcode_open'] = '&lt;blockcode&gt;';
00321           $this-&gt;options['_blockcode_close'] = '&lt;/blockcode&gt;';
00322           $this-&gt;options['css_mode'] = 1;
00323         } <span class="keywordflow">else</span> {
00324           <span class="comment">// xhtml 1.x</span>
00325           $this-&gt;options['_line_open'] = '';
00326           $this-&gt;options['_line_close'] = '&lt;br /&gt;';
00327           $this-&gt;options['_blockcode_open'] = '&lt;pre&gt;&lt;code&gt;';
00328           $this-&gt;options['_blockcode_close'] = '&lt;/code&gt;&lt;/pre&gt;';
00329           $this-&gt;options['css_mode'] = 1;
00330         }
00331       } elseif (preg_match('/^html/', $flavor)) {
00332         $this-&gt;options['_line_open'] = '';
00333         $this-&gt;options['_line_close'] = '&lt;br&gt;';
00334         $this-&gt;options['_blockcode_open'] = '&lt;pre&gt;&lt;code&gt;';
00335         $this-&gt;options['_blockcode_close'] = '&lt;/code&gt;&lt;/pre&gt;';
00336         $this-&gt;options['css_mode'] = preg_match('/\/<a class="code" href="classTextile.html#a6">css</a>/', $flavor);
00337       }
00338       <span class="keywordflow">if</span> ($this-&gt;options['css_mode'] &amp;&amp; !$this-&gt;options['<a class="code" href="classTextile.html#a6">css</a>']) { $this-&gt;<a class="code" href="classTextile.html#d26">_css_defaults</a>(); }
00339     }
00340     <span class="keywordflow">return</span> $this-&gt;options['flavor'];
00341   } <span class="comment">// function flavor</span>
00342 
<a name="l00404"></a><a class="code" href="classTextile.html#a6">00404</a>   function <a class="code" href="classTextile.html#a6">css</a>($css = NULL) {
00405     <span class="keywordflow">if</span> ($css != NULL) {
00406       <span class="keywordflow">if</span> (is_array($css)) {
00407         $this-&gt;options['css'] = $css;
00408         $this-&gt;options['css_mode'] = 1;
00409       } <span class="keywordflow">else</span> {
00410         $this-&gt;options['css_mode'] = $css;
00411         <span class="keywordflow">if</span> ($this-&gt;options['css_mode'] &amp;&amp; !$this-&gt;options['css']) { $this-&gt;<a class="code" href="classTextile.html#d26">_css_defaults</a>(); }
00412       }
00413     }
00414     <span class="keywordflow">return</span> ($this-&gt;options['css_mode'] ? $this-&gt;options['css'] : 0);
00415   } <span class="comment">// function css</span>
00416 
<a name="l00433"></a><a class="code" href="classTextile.html#a7">00433</a>   function <a class="code" href="classTextile.html#a7">charset</a>($charset = NULL) {
00434     <span class="keywordflow">if</span> ($charset != NULL) {
00435         $this-&gt;options['charset'] = $charset;
00436         <span class="keywordflow">if</span> (preg_match('/^utf-?8$/i', $this-&gt;options['charset'])) {
00437           $this-&gt;<a class="code" href="classTextile.html#a13">char_encoding</a>(0);
00438         } <span class="keywordflow">else</span> {
00439           $this-&gt;<a class="code" href="classTextile.html#a13">char_encoding</a>(1);
00440         }
00441     }
00442     <span class="keywordflow">return</span> $this-&gt;options['charset'];
00443   } <span class="comment">// function charset</span>
00444 
<a name="l00458"></a><a class="code" href="classTextile.html#a8">00458</a>   function <a class="code" href="classTextile.html#a8">docroot</a>($docroot = NULL) {
00459     <span class="keywordflow">if</span> ($docroot != NULL) {
00460       $this-&gt;options['docroot'] = $docroot;
00461     }
00462     <span class="keywordflow">return</span> $this-&gt;options['docroot'];
00463   } <span class="comment">// function docroot</span>
00464 
<a name="l00478"></a><a class="code" href="classTextile.html#a9">00478</a>   function <a class="code" href="classTextile.html#a9">trim_spaces</a>($trim_spaces = NULL) {
00479     <span class="keywordflow">if</span> ($trim_spaces != NULL) {
00480       $this-&gt;options['trim_spaces'] = $trim_spaces;
00481     }
00482     <span class="keywordflow">return</span> $this-&gt;options['trim_spaces'];
00483   } <span class="comment">// function trim_spaces</span>
00484 
<a name="l00495"></a><a class="code" href="classTextile.html#a10">00495</a>   function <a class="code" href="classTextile.html#a10">filter_param</a>($filter_param = NULL) {
00496     <span class="keywordflow">if</span> ($filter_param != NULL) {
00497       $this-&gt;options['filter_param'] = $filter_param;
00498     }
00499     <span class="keywordflow">return</span> $this-&gt;options['filter_param'];
00500   } <span class="comment">// function filter_param</span>
00501 
<a name="l00518"></a><a class="code" href="classTextile.html#a11">00518</a>   function <a class="code" href="classTextile.html#a11">preserve_spaces</a>($preserve_spaces = NULL) {
00519     <span class="keywordflow">if</span> ($preserve_spaces != NULL) {
00520       $this-&gt;options['preserve_spaces'] = $preserve_spaces;
00521     }
00522     <span class="keywordflow">return</span> $this-&gt;options['preserve_spaces'];
00523   } <span class="comment">// function preserve_spaces</span>
00524 
<a name="l00537"></a><a class="code" href="classTextile.html#a12">00537</a>   function <a class="code" href="classTextile.html#a12">filters</a>($filters = NULL) {
00538     <span class="keywordflow">if</span> ($filters != NULL) {
00539       $this-&gt;options['filters'] = $filters;
00540     }
00541     <span class="keywordflow">return</span> $this-&gt;options['filters'];
00542   } <span class="comment">// function filters</span>
00543 
<a name="l00558"></a><a class="code" href="classTextile.html#a13">00558</a>   function <a class="code" href="classTextile.html#a13">char_encoding</a>($char_encoding = NULL) {
00559     <span class="keywordflow">if</span> ($char_encoding != NULL) {
00560       $this-&gt;options['char_encoding'] = $char_encoding;
00561     }
00562     <span class="keywordflow">return</span> $this-&gt;options['char_encoding'];
00563   } <span class="comment">// function char_encoding</span>
00564 
<a name="l00577"></a><a class="code" href="classTextile.html#a14">00577</a>   function <a class="code" href="classTextile.html#a14">handle_quotes</a>($do_quotes = NULL) {
00578     <span class="keywordflow">if</span> ($do_quotes != NULL) {
00579       $this-&gt;options['do_quotes'] = $do_quotes;
00580     }
00581     <span class="keywordflow">return</span> $this-&gt;options['do_quotes'];
00582   } <span class="comment">// function handle_quotes</span>
00583 
00584   <span class="comment">// end of getter/setter methods</span>
00585 
<a name="l00599"></a><a class="code" href="classTextile.html#d0">00599</a>   function <a class="code" href="classTextile.html#d0">_create_re</a>() {
00600     <span class="comment">// a URL discovery regex. This is from Mastering Regex from O'Reilly.</span>
00601     <span class="comment">// Some modifications by Brad Choate &lt;brad at bradchoate dot com&gt;</span>
00602     $this-&gt;urlre = '(?:
00603 <span class="preprocessor">    # Must start out right...</span>
00604 <span class="preprocessor"></span>    (?=[a-zA-Z0-9./#])
00605 <span class="preprocessor">    # Match the leading part (proto://hostname, or just hostname)</span>
00606 <span class="preprocessor"></span>    (?:
00607 <span class="preprocessor">        # ftp://, http://, or https:// leading part</span>
00608 <span class="preprocessor"></span>        (?:ftp|https?|telnet|nntp):<span class="comment">//(?:\w+(?::\w+)?@)?[-\w]+(?:\.\w[-\w]*)+</span>
00609         |
00610         (?:mailto:)?[-\+\w]+@[-\w]+(?:\.\w[-\w]*)+
00611         |
00612 <span class="preprocessor">        # or, try to find a hostname with our more specific sub-expression</span>
00613 <span class="preprocessor"></span>        (?i: [a-z0-9] (?:[-a-z0-9]*[a-z0-9])? \. )+ # sub domains
00614 <span class="preprocessor">        # Now ending .com, etc. For these, require lowercase</span>
00615 <span class="preprocessor"></span>        (?-i: com\b
00616             | edu\b
00617             | biz\b
00618             | gov\b
00619             | in(?:t|fo)\b # .int or .info
00620             | mil\b
00621             | net\b
00622             | org\b
00623             | museum\b
00624             | aero\b
00625             | coop\b
00626             | name\b
00627             | pro\b
00628             | [a-z][a-z]\b # two-letter country codes
00629         )
00630     )?
00631 
00632 <span class="preprocessor">    # Allow an optional port number</span>
00633 <span class="preprocessor"></span>    (?: : \d+ )?
00634 
00635 <span class="preprocessor">    # The rest of the URL is optional, and begins with / . . .</span>
00636 <span class="preprocessor"></span>    (?:
00637      /?
00638 <span class="preprocessor">     # The rest are heuristics for what seems to work well</span>
00639 <span class="preprocessor"></span>     [^.!,?;:<span class="stringliteral">"\'&lt;&gt;()\[\]{}\s\x7F-\xFF]*</span>
00640 <span class="stringliteral">     (?:</span>
00641 <span class="stringliteral">        [.!,?;:]+  [^.!,?;:"</span>\'&lt;&gt;()\[\]{}\s\x7F-\xFF]+ #\'<span class="stringliteral">"</span>
00642 <span class="stringliteral">     )*</span>
00643 <span class="stringliteral">    )?</span>
00644 <span class="stringliteral">)';</span>
00645 <span class="stringliteral"></span>
00646 <span class="stringliteral">    $this-&gt;punct = '[\!"</span>\#\$%&amp;\'()\*\+,\-\./:;&lt;=&gt;\?@\[\\\\\]\^_`{\|}\~]';
00647     $this-&gt;valignre = '[\-^~]';
00648     $this-&gt;tblalignre = '[&lt;&gt;=]';
00649     $this-&gt;halignre = '(?:&lt;&gt;|[&lt;&gt;=])';
00650     $this-&gt;alignre = '(?:(?:' . $this-&gt;valignre . '|&lt;&gt;' . $this-&gt;valignre . '?|' . $this-&gt;valignre . '?&lt;&gt;|' . $this-&gt;valignre . <span class="charliteral">'?'</span> . $this-&gt;halignre . '?|' . $this-&gt;halignre . <span class="charliteral">'?'</span> . $this-&gt;valignre . '?)(?!\w))';
00651     $this-&gt;imgalignre = '(?:(?:[&lt;&gt;]|' . $this-&gt;valignre . '){1,2})';
00652 
00653     $this-&gt;clstypadre = '(?:
00654   (?:\([A-Za-z0-9_\- \#]+\))
00655   |
00656   (?:{
00657       (?: \( [^)]+ \) | [^\}] )+
00658      })
00659   |
00660   (?:\(+? (?![A-Za-z0-9_\-\#]) )
00661   |
00662   (?:\)+?)
00663   |
00664   (?: \[ [a-zA-Z\-]+? \] )
00665 )';
00666 
00667     $this-&gt;clstyre = '(?:
00668   (?:\([A-Za-z0-9_\- \#]+\))
00669   |
00670   (?:{
00671       [A-Za-z0-9_\-](?: \( [^)]+ \) | [^\}] )+
00672      })
00673   |
00674   (?: \[ [a-zA-Z\-]+? \] )
00675 )';
00676 
00677     $this-&gt;clstyfiltre = '(?:
00678   (?:\([A-Za-z0-9_\- \#]+\))
00679   |
00680   (?:{
00681       [A-Za-z0-9_\-](?: \( [^)]+ \) | [^\}] )+
00682      })
00683   |
00684   (?:\|[^\|]+\|)
00685   |
00686   (?:\(+?(?![A-Za-z0-9_\-\#]))
00687   |
00688   (?:\)+)
00689   |
00690   (?: \[ [a-zA-Z]+? \] )
00691 )';
00692 
00693     $this-&gt;codere = '(?:
00694     (?:
00695       [\[{]
00696       @                           # opening
00697       (?:\[([A-Za-z0-9]+)\])?     # $1: language <span class="keywordtype">id</span>
00698       (.+?)                       # $2: code
00699       @                           # closing
00700       [\]}]
00701     )
00702     |
00703     (?:
00704       (?:^|(?&lt;=[\s\(]))
00705       @                           # opening
00706       (?:\[([A-Za-z0-9]+)\])?     # $3: language <span class="keywordtype">id</span>
00707       ([^\s].+?[^\s])             # $4: code itself
00708       @                           # closing
00709       (?:$|(?=' . $this-&gt;punct . '{1,2}|\s))
00710     )
00711 )';
00712 
00713     $this-&gt;blocktags = '
00714     &lt;
00715     (( /? ( h[1-6]
00716      | p
00717      | pre
00718      | div
00719      | table
00720      | t[rdh]
00721      | [ou]l
00722      | li
00723      | block(?:quote|code)
00724      | form
00725      | input
00726      | select
00727      | option
00728      | textarea
00729      )
00730     [ &gt;]
00731     )
00732     | !--
00733     )
00734 ';
00735   } <span class="comment">// function _create_re</span>
00736 
<a name="l00746"></a><a class="code" href="classTextile.html#a15">00746</a>   function process($str) {
00747     <span class="comment">/*</span>
00748 <span class="comment">     * Function names in PHP are case insensitive, so function</span>
00749 <span class="comment">     * textile() cannot be redefined.  Thus, this PHP implementation</span>
00750 <span class="comment">     * will only use process().</span>
00751 <span class="comment">     *</span>
00752 <span class="comment">     *   return $this-&gt;textile($str);</span>
00753 <span class="comment">     * } // function process</span>
00754 <span class="comment">     *</span>
00755 <span class="comment">     * function textile($str) {</span>
00756 <span class="comment">     */</span>
00757 
00758     <span class="comment">// quick translator for abbreviated block names</span>
00759     <span class="comment">// to their tag</span>
00760     $macros = array('bq' =&gt; 'blockquote');
00761 
00762     <span class="comment">// an array to hold any portions of the text to be preserved</span>
00763     <span class="comment">// without further processing by Textile</span>
00764     array_unshift($this-&gt;repl, array());
00765 
00766     <span class="comment">// strip out extra newline characters. we're only matching for \n herein</span>
00767     <span class="comment">//$str = preg_replace('!(?:\r?\n|\r)!', "\n", $str);</span>
00768     $str = preg_replace('!(?:\015?\012|\015)!', <span class="stringliteral">"\n"</span>, $str);
00769 
00770     <span class="comment">// optionally remove trailing spaces</span>
00771     <span class="keywordflow">if</span> ($this-&gt;options['trim_spaces']) { $str = preg_replace('/ +$/m', '', $str); }
00772 
00773     <span class="comment">// preserve contents of the '==', 'pre', 'blockcode' sections</span>
00774     $str = preg_replace_callback('{(^|\n\n)==(.+?)==($|\n\n)}s',
00775                                  $this-&gt;_cb('<span class="stringliteral">"$m[1]\n\n"</span> . $me-&gt;_repl($me-&gt;repl[0], $me-&gt;format_block(array(<span class="stringliteral">"text"</span> =&gt; $m[2]))) . <span class="stringliteral">"\n\n$m[3]"</span>'), $str);
00776 
00777     <span class="keywordflow">if</span> (!$this-&gt;disable_html()) {
00778       <span class="comment">// preserve style, script tag contents</span>
00779       $str = preg_replace_callback('!(&lt;(style|script)(?:&gt;| .+?&gt;).*?&lt;/\2&gt;)!s', $this-&gt;_cb('$me-&gt;_repl($me-&gt;repl[0], $m[1])'), $str);
00780 
00781       <span class="comment">// preserve HTML comments</span>
00782       $str = preg_replace_callback('|(&lt;!--.+?--&gt;)|s', $this-&gt;_cb('$me-&gt;_repl($me-&gt;repl[0], $m[1])'), $str);
00783 
00784       <span class="comment">// preserve pre block contents, encode contents by default</span>
00785       $pre_start = count($this-&gt;repl[0]);
00786       $str = preg_replace_callback('{(&lt;pre(?: [^&gt;]*)?&gt;)(.+?)(&lt;/pre&gt;)}s',
00787                                    $this-&gt;_cb('<span class="stringliteral">"\n\n"</span> . $me-&gt;_repl($me-&gt;repl[0], $m[1] . $me-&gt;encode_html($m[2], 1) . $m[3]) . <span class="stringliteral">"\n\n"</span>'), $str);
00788       <span class="comment">// fix code tags within pre blocks we just saved.</span>
00789       <span class="keywordflow">for</span> ($i = $pre_start; $i &lt; count($this-&gt;repl[0]); $i++) {
00790         $this-&gt;repl[0][$i] = preg_replace('|&amp;lt;(/?)code(.*?)&amp;gt;|s', '&lt;$1code$2&gt;', $this-&gt;repl[0][$i]);
00791       }
00792 
00793       <span class="comment">// preserve code blocks by default, encode contents</span>
00794       $str = preg_replace_callback('{(&lt;code(?: [^&gt;]+)?&gt;)(.+?)(&lt;/code&gt;)}s',
00795                                    $this-&gt;_cb('$me-&gt;_repl($me-&gt;repl[0], $m[1] . $me-&gt;encode_html($m[2], 1) . $m[3])'), $str);
00796 
00797       <span class="comment">// encode blockcode tag (an XHTML 2 tag) and encode it's</span>
00798       <span class="comment">// content by default</span>
00799       $str = preg_replace_callback('{(&lt;blockcode(?: [^&gt;]+)?&gt;)(.+?)(&lt;/blockcode&gt;)}s',
00800                                    $this-&gt;_cb('<span class="stringliteral">"\n\n"</span> . $me-&gt;_repl($me-&gt;repl[0], $m[1] . $me-&gt;encode_html($m[2], 1) . $m[3]) . <span class="stringliteral">"\n\n"</span>'), $str);
00801 
00802       <span class="comment">// preserve PHPish, ASPish code</span>
00803       $str = preg_replace_callback('!(&lt;([\?%]).*?(\2)&gt;)!s', $this-&gt;_cb('$me-&gt;_repl($me-&gt;repl[0], $m[1])'), $str);
00804     }
00805 
00806     <span class="comment">// pass through and remove links that follow this format</span>
00807     <span class="comment">// [id_without_spaces (optional title text)]url</span>
00808     <span class="comment">// lines like this are stripped from the content, and can be</span>
00809     <span class="comment">// referred to using the "link text":id_without_spaces syntax</span>
00810     <span class="comment">//$links = array();</span>
00811     $str = preg_replace_callback('{(?:\n|^) [ ]* \[ ([^ ]+?) [ ]*? (?:\( (.+?) \) )?  \] ((?:(?:ftp|https?|telnet|nntp):<span class="comment">//|/)[^ ]+?) [ ]* (\n|$)}mx',</span>
00812                                  $this-&gt;_cb('($me-&gt;links[$m[1]] = array(<span class="stringliteral">"url"</span> =&gt; $m[3], <span class="stringliteral">"title"</span> =&gt; $m[2])) ? $m[4] : $m[4]'), $str);
00813     <span class="comment">//$this-&gt;links = $links;</span>
00814 
00815     <span class="comment">// eliminate starting/ending blank lines</span>
00816     $str = preg_replace('/^\n+/s', '', $str, 1);
00817     $str = preg_replace('/\n+$/s', '', $str, 1);
00818 
00819     <span class="comment">// split up text into paragraph blocks, capturing newlines too</span>
00820     $para = preg_split('/(\n{2,})/', $str, -1, PREG_SPLIT_DELIM_CAPTURE);
00821     unset($block, $bqlang, $filter, $<span class="keyword">class</span>, $sticky, $lines,
00822           $style, $stickybuff, $lang, $clear);
00823 
00824     $out = '';
00825 
00826     foreach ($para as $para) {
00827       <span class="keywordflow">if</span> (preg_match('/^\n+$/s', $para)) {
00828         <span class="keywordflow">if</span> ($sticky &amp;&amp; $stickybuff) {
00829           $stickybuff .= $para;
00830         } <span class="keywordflow">else</span> {
00831           $out .= $para;
00832         }
00833         <span class="keywordflow">continue</span>;
00834       }
00835 
00836       <span class="keywordflow">if</span> ($sticky) {
00837         $sticky++;
00838       } <span class="keywordflow">else</span> {
00839         unset($block);
00840         unset($<span class="keyword">class</span>);
00841         $style = '';
00842         unset($lang);
00843       }
00844 
00845       unset($<span class="keywordtype">id</span>, $cite, $align, $padleft, $padright, $lines, $buffer);
00846       <span class="keywordflow">if</span> (preg_match('{^(h[1-6]|p|bq|bc|fn\d+)
00847                         ((?:' . $this-&gt;clstyfiltre . '*|' . $this-&gt;halignre . ')*)
00848                         (\.\.?)
00849                         (?::(\d+|' . $this-&gt;urlre . '))?\ (.*)$}sx', $para, $matches)) {
00850         <span class="keywordflow">if</span> ($sticky) {
00851           <span class="keywordflow">if</span> ($block == 'bc') {
00852             <span class="comment">// close our blockcode section</span>
00853             $out = preg_replace('/\n\n$/', '', $out, 1);
00854             $out .= $this-&gt;options['_blockcode_close'] . <span class="stringliteral">"\n\n"</span>;
00855           } elseif ($block == 'bq') {
00856             $out = preg_replace('/\n\n$/', '', $out, 1);
00857             $out .= '&lt;/blockquote&gt;' . <span class="stringliteral">"\n\n"</span>;
00858           } elseif ($block == 'table') {
00859             $table_out = $this-&gt;format_table(array('text' =&gt; $stickybuff));
00860             <span class="keywordflow">if</span> (!$table_out) { $table_out = ''; }
00861             $out .= $table_out;
00862             unset($stickybuff);
00863           } elseif ($block == 'dl') {
00864             $dl_out = $this-&gt;format_deflist(array('text' =&gt; $stickybuff));
00865             <span class="keywordflow">if</span> (!$dl_out) { $dl_out = ''; }
00866             $out .= $dl_out;
00867             unset($stickybuff);
00868           }
00869           $sticky = 0;
00870         }
00871         <span class="comment">// block macros: h[1-6](class)., bq(class)., bc(class)., p(class).</span>
00872         <span class="comment">//warn "paragraph: [[$para]]\n\tblock: $1\n\tparams: $2\n\tcite: $4";</span>
00873         $block = $matches[1];
00874         $params = $matches[2];
00875         $cite = $matches[4];
00876         <span class="keywordflow">if</span> ($matches[3] == '..') {
00877           $sticky = 1;
00878         } <span class="keywordflow">else</span> {
00879           $sticky = 0;
00880           unset($<span class="keyword">class</span>);
00881           unset($bqlang);
00882           unset($lang);
00883           $style = '';
00884           unset($filter);
00885         }
00886         <span class="keywordflow">if</span> (preg_match('/^h([1-6])$/', $block, $matches2)) {
00887           <span class="keywordflow">if</span> ($this-&gt;options['head_offset']) {
00888             $block = <span class="charliteral">'h'</span> . ($matches2[1] + $this-&gt;options['head_offset']);
00889           }
00890         }
00891         <span class="keywordflow">if</span> (preg_match('{(' . $this-&gt;halignre . '+)}', $params, $matches2)) {
00892           $align = $matches2[1];
00893           $params = preg_replace(<span class="charliteral">'{'</span> . $this-&gt;halignre . '+}', '', $params, 1);
00894         }
00895         <span class="keywordflow">if</span> ($params) {
00896           <span class="keywordflow">if</span> (preg_match('/\|(.+)\|/', $params, $matches2)) {
00897             $filter = $matches2[1];
00898             $params = preg_replace('/\|.+?\|/', '', $params, 1);
00899           }
00900           <span class="keywordflow">if</span> (preg_match('/{([^}]+)}/', $params, $matches2)) {
00901             $style = $matches2[1];
00902             $style = preg_replace('/\n/', <span class="charliteral">' '</span>, $style);
00903             $params = preg_replace('/{[^}]+}/', '', $params);
00904           }
00905           <span class="keywordflow">if</span> (preg_match('/\(([A-Za-z0-9_\-\ ]+?)(?:\#(.+?))?\)/', $params, $matches2) ||
00906               preg_match('/\(([A-Za-z0-9_\-\ ]+?)?(?:\#(.+?))\)/', $params, $matches2)) {
00907             <span class="keywordflow">if</span> ($matches2[1] || $matches2[2]) {
00908               $class = $matches2[1];
00909               $id = $matches2[2];
00910               <span class="keywordflow">if</span> ($class) {
00911                 $params = preg_replace('/\([A-Za-z0-9_\-\ ]+?(#.*?)?\)/', '', $params);
00912               } elseif ($<span class="keywordtype">id</span>) {
00913                 $params = preg_replace('/\(#.+?\)/', '', $params);
00914               }
00915             }
00916           }
00917           <span class="keywordflow">if</span> (preg_match('/(\(+)/', $params, $matches2)) {
00918             $padleft = strlen($matches2[1]);
00919             $params = preg_replace('/\(+/', '', $params, 1);
00920           }
00921           <span class="keywordflow">if</span> (preg_match('/(\)+)/', $params, $matches2)) {
00922             $padright = strlen($matches2[1]);
00923             $params = preg_replace('/\)+/', '', $params, 1);
00924           }
00925           <span class="keywordflow">if</span> (preg_match('/\[(.+?)\]/', $params, $matches2)) {
00926             $lang = $matches2[1];
00927             <span class="keywordflow">if</span> ($block == 'bc') {
00928               $bqlang = $lang;
00929               unset($lang);
00930             }
00931             $params = preg_replace('/\[.+?\]/', '', $params, 1);
00932           }
00933         }
00934         <span class="comment">// warn "settings:\n\tblock: $block\n\tpadleft: $padleft\n\tpadright: $padright\n\tclass: $class\n\tstyle: $style\n\tid: $id\n\tfilter: $filter\n\talign: $align\n\tlang: $lang\n\tsticky: $sticky";</span>
00935         $para = $matches[5];
00936       } elseif (preg_match('|^&lt;textile#(\d+)&gt;$|', $para, $matches)) {
00937         $buffer = $this-&gt;repl[0][$matches[1] - 1];
00938       } elseif (preg_match('/^clear([&lt;&gt;]+)?\.$/', $para, $matches)) {
00939         <span class="keywordflow">if</span> ($matches[1] == <span class="charliteral">'&lt;'</span>) {
00940           $clear = 'left';
00941         } elseif ($matches[1] == <span class="charliteral">'&gt;'</span>) {
00942           $clear = 'right';
00943         } <span class="keywordflow">else</span> {
00944           $clear = 'both';
00945         }
00946         <span class="keywordflow">continue</span>;
00947       } elseif ($sticky &amp;&amp; $stickybuff &amp;&amp;
00948                 ($block == 'table' || $block == 'dl')) {
00949         $stickybuff .= $para;
00950         <span class="keywordflow">continue</span>;
00951       } elseif (preg_match('{^(?:' . $this-&gt;halignre . <span class="charliteral">'|'</span> . $this-&gt;clstypadre . '*)*
00952                               [\*\#]
00953                               (?:' . $this-&gt;halignre . <span class="charliteral">'|'</span> . $this-&gt;clstypadre . '*)*
00954                               \ }x', $para)) {
00955         <span class="comment">// '*', '#' prefix means a list</span>
00956         $buffer = $this-&gt;format_list(array('text' =&gt; $para));
00957       } elseif (preg_match('{^(?:table(?:' . $this-&gt;tblalignre . <span class="charliteral">'|'</span> . $this-&gt;clstypadre . '*)*
00958                               (\.\.?)\s+)?
00959                               (?:_|' . $this-&gt;alignre . <span class="charliteral">'|'</span> . $this-&gt;clstypadre . '*)*\|}x', $para, $matches)) {
00960         <span class="comment">// handle wiki-style tables</span>
00961         <span class="keywordflow">if</span> ($matches[1] &amp;&amp; ($matches[1] == '..')) {
00962           $block = 'table';
00963           $stickybuff = $para;
00964           $sticky = 1;
00965           <span class="keywordflow">continue</span>;
00966         } <span class="keywordflow">else</span> {
00967           $buffer = $this-&gt;format_table(array('text' =&gt; $para));
00968         }
00969       } elseif (preg_match('{^(?:dl(?:' . $this-&gt;clstyre . ')*(\.\.?)\s+)}x', $para, $matches)) {
00970         <span class="comment">// handle definition lists</span>
00971         <span class="keywordflow">if</span> ($matches[1] &amp;&amp; ($matches[1] == '..')) {
00972           $block = 'dl';
00973           $stickybuff = $para;
00974           $sticky = 1;
00975           <span class="keywordflow">continue</span>;
00976         } <span class="keywordflow">else</span> {
00977           $buffer = $this-&gt;format_deflist(array('text' =&gt; $para));
00978         }
00979       }
00980       <span class="keywordflow">if</span> ($buffer) {
00981         $out .= $buffer;
00982         <span class="keywordflow">continue</span>;
00983       }
00984       $lines = preg_split('/\n/', $para);
00985       <span class="keywordflow">if</span> ((count($lines) == 1) &amp;&amp; ($lines[0] == '')) {
00986         <span class="keywordflow">continue</span>;
00987       }
00988 
00989       $block = ($block ? $block : <span class="charliteral">'p'</span>);
00990 
00991       $buffer = '';
00992       $pre = '';
00993       $post = '';
00994 
00995       <span class="keywordflow">if</span> ($block == 'bc') {
00996         <span class="keywordflow">if</span> ($sticky &lt;= 1) {
00997           $pre .= $this-&gt;options['_blockcode_open'];
00998           $pre = preg_replace('/&gt;$/s', '', $pre, 1);
00999           <span class="keywordflow">if</span> ($bqlang) { $pre .= <span class="stringliteral">" language=\"$bqlang\""</span>; }
01000           <span class="keywordflow">if</span> ($align) {
01001             $alignment = $this-&gt;_halign($align);
01002             <span class="keywordflow">if</span> ($this-&gt;options['css_mode']) {
01003               <span class="keywordflow">if</span> (($padleft || $padright) &amp;&amp;
01004                   (($alignment == 'left') || ($alignment == 'right'))) {
01005                 $style .= ';<span class="keywordtype">float</span>:' . $alignment;
01006               } <span class="keywordflow">else</span> {
01007                 $style .= ';text-align:' . $alignment;
01008               }
01009               $class .= <span class="charliteral">' '</span> . ($this-&gt;options['css'][<span class="stringliteral">"class_align_$alignment"</span>] ? $this-&gt;options['css'][<span class="stringliteral">"class_align_$alignment"</span>] : $alignment);
01010             } <span class="keywordflow">else</span> {
01011               <span class="keywordflow">if</span> ($alignment) { $pre .= <span class="stringliteral">" align=\"$alignment\""</span>; }
01012             }
01013           }
01014           <span class="keywordflow">if</span> ($padleft) { $style .= <span class="stringliteral">";padding-left:${padleft}em"</span>; }
01015           <span class="keywordflow">if</span> ($padright) { $style .= <span class="stringliteral">";padding-right:${padright}em"</span>; }
01016           <span class="keywordflow">if</span> ($clear) { $style .= <span class="stringliteral">";clear:${clear}"</span>; }
01017           <span class="keywordflow">if</span> ($class) { $class = preg_replace('/^ /', '', $<span class="keyword">class</span>, 1); }
01018           <span class="keywordflow">if</span> ($class) { $pre .= <span class="stringliteral">" class=\"$class\""</span>; }
01019           <span class="keywordflow">if</span> ($id) { $pre .= <span class="stringliteral">" id=\"$id\""</span>; }
01020           <span class="keywordflow">if</span> ($style) { $style = preg_replace('/^;/', '', $style, 1); }
01021           <span class="keywordflow">if</span> ($style) { $pre .= <span class="stringliteral">" style=\"$style\""</span>; }
01022           <span class="keywordflow">if</span> ($lang) { $pre .= <span class="stringliteral">" lang=\"$lang\""</span>; }
01023           $pre .= <span class="charliteral">'&gt;'</span>;
01024           unset($lang);
01025           unset($bqlang);
01026           unset($clear);
01027         }
01028         $para = preg_replace_callback('{(?:^|(?&lt;=[\s&gt;])|([{[]))
01029                                         ==(.+?)==
01030                                         (?:$|([\]}])|(?=' . $this-&gt;punct . '{1,2}|\s))}sx',
01031                                       $this-&gt;_cb('$me-&gt;_repl($me-&gt;repl[0], $me-&gt;format_block(array(<span class="stringliteral">"text"</span> =&gt; $m[2], <span class="stringliteral">"inline"</span> =&gt; 1, <span class="stringliteral">"pre"</span> =&gt; $m[1], <span class="stringliteral">"post"</span> =&gt; $m[3])))'), $para);
01032         $buffer .= $this-&gt;encode_html_basic($para, 1);
01033         $buffer = preg_replace('/&amp;lt;textile#(\d+)&amp;gt;/', '&lt;textile#$1&gt;', $buffer);
01034         <span class="keywordflow">if</span> ($sticky == 0) {
01035           $post .= $this-&gt;options['_blockcode_close'];
01036         }
01037         $out .= $pre . $buffer . $post;
01038         <span class="keywordflow">continue</span>;
01039       } elseif ($block == 'bq') {
01040         <span class="keywordflow">if</span> ($sticky &lt;= 1) {
01041           $pre .= '&lt;blockquote';
01042           <span class="keywordflow">if</span> ($align) {
01043             $alignment = $this-&gt;_halign($align);
01044             <span class="keywordflow">if</span> ($this-&gt;options['css_mode']) {
01045               <span class="keywordflow">if</span> (($padleft || $padright) &amp;&amp;
01046                   (($alignment == 'left') || ($alignment == 'right'))) {
01047                 $style .= ';<span class="keywordtype">float</span>:' . $alignment;
01048               } <span class="keywordflow">else</span> {
01049                 $style .= ';text-align:' . $alignment;
01050               }
01051               $class .= <span class="charliteral">' '</span> . ($this-&gt;options['css'][<span class="stringliteral">"class_align_$alignment"</span>] ? $this-&gt;options['css'][<span class="stringliteral">"class_align_$alignment"</span>] : $alignment);
01052             } <span class="keywordflow">else</span> {
01053               <span class="keywordflow">if</span> ($alignment) { $pre .= <span class="stringliteral">" align=\"$alignment\""</span>; }
01054             }
01055           }
01056           <span class="keywordflow">if</span> ($padleft) { $style .= <span class="stringliteral">";padding-left:${padleft}em"</span>; }
01057           <span class="keywordflow">if</span> ($padright) { $style .= <span class="stringliteral">";padding-right:${padright}em"</span>; }
01058           <span class="keywordflow">if</span> ($clear) { $style .= <span class="stringliteral">";clear:${clear}"</span>; }
01059           <span class="keywordflow">if</span> ($class) { $class = preg_replace('/^ /', '', $<span class="keyword">class</span>, 1); }
01060           <span class="keywordflow">if</span> ($class) { $pre .= <span class="stringliteral">" class=\"$class\""</span>; }
01061           <span class="keywordflow">if</span> ($id) { $pre .= <span class="stringliteral">" id=\"$id\""</span>; }
01062           <span class="keywordflow">if</span> ($style) { $style = preg_replace('/^;/', '', $style, 1); }
01063           <span class="keywordflow">if</span> ($style) { $pre .= <span class="stringliteral">" style=\"$style\""</span>; }
01064           <span class="keywordflow">if</span> ($lang) { $pre .= <span class="stringliteral">" lang=\"$lang\""</span>; }
01065           <span class="keywordflow">if</span> ($cite) { $pre .= ' cite=<span class="stringliteral">"' . $this-&gt;format_url(array('url' =&gt; $cite)) . '"</span>'; }
01066           $pre .= <span class="charliteral">'&gt;'</span>;
01067           unset($clear);
01068         }
01069         $pre .= '&lt;p&gt;';
01070       } elseif (preg_match('/fn(\d+)/', $block, $matches)) {
01071         $fnum = $matches[1];
01072         $pre .= '&lt;p';
01073         <span class="keywordflow">if</span> ($this-&gt;options['css']['class_footnote']) { $class .= <span class="charliteral">' '</span> . $this-&gt;options['css']['class_footnote']; }
01074         <span class="keywordflow">if</span> ($align) {
01075           $alignment = $this-&gt;_halign($align);
01076           <span class="keywordflow">if</span> ($this-&gt;options['css_mode']) {
01077             <span class="keywordflow">if</span> (($padleft || $padright) &amp;&amp;
01078                 (($alignment == 'left') || ($alignment == 'right'))) {
01079               $style .= ';<span class="keywordtype">float</span>:' . $alignment;
01080             } <span class="keywordflow">else</span> {
01081               $style .= ';text-align:' . $alignment;
01082             }
01083             $class .= ($this-&gt;options['css'][<span class="stringliteral">"class_align_$alignment"</span>] ? $this-&gt;options['css'][<span class="stringliteral">"class_align_$alignment"</span>] : $alignment);
01084           } <span class="keywordflow">else</span> {
01085             $pre .= <span class="stringliteral">" align=\"$alignment\""</span>;
01086           }
01087         }
01088         <span class="keywordflow">if</span> ($padleft) { $style .= <span class="stringliteral">";padding-left:${padleft}em"</span>; }
01089         <span class="keywordflow">if</span> ($padright) { $style .= <span class="stringliteral">";padding-right:${padright}em"</span>; }
01090         <span class="keywordflow">if</span> ($clear) { $style .= <span class="stringliteral">";clear:${clear}"</span>; }
01091         <span class="keywordflow">if</span> ($class) { $class = preg_replace('/^ /', '', $<span class="keyword">class</span>, 1); }
01092         <span class="keywordflow">if</span> ($class) { $pre .= <span class="stringliteral">" class=\"$class\""</span>; }
01093         $pre .= ' <span class="keywordtype">id</span>=<span class="stringliteral">"' . ($this-&gt;options['css']['id_footnote_prefix'] ? $this-&gt;options['css']['id_footnote_prefix'] : 'fn') . $fnum . '"</span>';
01094         <span class="keywordflow">if</span> ($style) { $style = preg_replace('/^;/', '', $style, 1); }
01095         <span class="keywordflow">if</span> ($style) { $pre .= <span class="stringliteral">" style=\"$style\""</span>; }
01096         <span class="keywordflow">if</span> ($lang) { $pre .= <span class="stringliteral">" lang=\"$lang\""</span>; }
01097         $pre .= <span class="charliteral">'&gt;'</span>;
01098         $pre .= '&lt;sup&gt;' . $fnum . '&lt;/sup&gt; ';
01099         <span class="comment">// we can close like a regular paragraph tag now</span>
01100         $block = <span class="charliteral">'p'</span>;
01101         unset($clear);
01102       } <span class="keywordflow">else</span> {
01103         $pre .= <span class="charliteral">'&lt;'</span> . ($macros[$block] ? $macros[$block] : $block);
01104         <span class="keywordflow">if</span> ($align) {
01105           $alignment = $this-&gt;_halign($align);
01106           <span class="keywordflow">if</span> ($this-&gt;options['css_mode']) {
01107             <span class="keywordflow">if</span> (($padleft || $padright) &amp;&amp;
01108                 (($alignment == 'left') || ($alignment == 'right'))) {
01109               $style .= ';<span class="keywordtype">float</span>:' . $alignment;
01110             } <span class="keywordflow">else</span> {
01111               $style .= ';text-align:' . $alignment;
01112             }
01113             $class .= <span class="charliteral">' '</span> . ($this-&gt;options['css'][<span class="stringliteral">"class_align_$alignment"</span>] ? $this-&gt;options['css'][<span class="stringliteral">"class_align_$alignment"</span>] : $alignment);
01114           } <span class="keywordflow">else</span> {
01115             $pre .= <span class="stringliteral">" align=\"$alignment\""</span>;
01116           }
01117         }
01118         <span class="keywordflow">if</span> ($padleft) { $style .= <span class="stringliteral">";padding-left:${padleft}em"</span>; }
01119         <span class="keywordflow">if</span> ($padright) { $style .= <span class="stringliteral">";padding-right:${padright}em"</span>; }
01120         <span class="keywordflow">if</span> ($clear) { $style .= <span class="stringliteral">";clear:${clear}"</span>; }
01121         <span class="keywordflow">if</span> ($class) { $class = preg_replace('/^ /', '', $<span class="keyword">class</span>, 1); }
01122         <span class="keywordflow">if</span> ($class) { $pre .= <span class="stringliteral">" class=\"$class\""</span>; }
01123         <span class="keywordflow">if</span> ($id) { $pre .= <span class="stringliteral">" id=\"$id\""</span>; }
01124         <span class="keywordflow">if</span> ($style) { $style = preg_replace('/^;/', '', $style, 1); }
01125         <span class="keywordflow">if</span> ($style) { $pre .= <span class="stringliteral">" style=\"$style\""</span>; }
01126         <span class="keywordflow">if</span> ($lang) { $pre .= <span class="stringliteral">" lang=\"$lang\""</span>; }
01127         <span class="keywordflow">if</span> ($cite &amp;&amp; ($block == 'bq')) { $pre .= ' cite=<span class="stringliteral">"' . $this-&gt;format_url(array('url' =&gt; $cite)) . '"</span>'; }
01128         $pre .= <span class="charliteral">'&gt;'</span>;
01129         unset($clear);
01130       }
01131 
01132       $buffer = $this-&gt;format_paragraph(array('text' =&gt; $para));
01133 
01134       <span class="keywordflow">if</span> ($block == 'bq') {
01135         <span class="keywordflow">if</span> (!preg_match('/&lt;p[ &gt;]/', $buffer)) { $post .= '&lt;/p&gt;'; }
01136         <span class="keywordflow">if</span> ($sticky == 0) {
01137           $post .= '&lt;/blockquote&gt;';
01138         }
01139       } <span class="keywordflow">else</span> {
01140         $post .= '&lt;/' . $block . <span class="charliteral">'&gt;'</span>;
01141       }
01142 
01143       <span class="keywordflow">if</span> (preg_match(<span class="charliteral">'{'</span> . $this-&gt;blocktags . '}x', $buffer)) {
01144         $buffer = preg_replace('/^\n\n/s', '', $buffer, 1);
01145         $out .= $buffer;
01146       } <span class="keywordflow">else</span> {
01147         <span class="keywordflow">if</span> ($filter) { $buffer = $this-&gt;format_block(array('text' =&gt; <span class="stringliteral">"|$filter|"</span> . $buffer, '<span class="keyword">inline</span>' =&gt; 1)); }
01148         $out .= $pre . $buffer . $post;
01149       }
01150     }
01151 
01152     <span class="keywordflow">if</span> ($sticky) {
01153       <span class="keywordflow">if</span> ($block == 'bc') {
01154         <span class="comment">// close our blockcode section</span>
01155         $out .= $this-&gt;options['_blockcode_close']; <span class="comment">// . "\n\n";</span>
01156       } elseif ($block == 'bq') {
01157         $out .= '&lt;/blockquote&gt;'; <span class="comment">// . "\n\n";</span>
01158       } elseif (($block == 'table') &amp;&amp; $stickybuff) {
01159         $table_out = $this-&gt;format_table(array('text' =&gt; $stickybuff));
01160         <span class="keywordflow">if</span> ($table_out) { $out .= $table_out; }
01161       } elseif (($block == 'dl') &amp;&amp; $stickybuff) {
01162         $dl_out = $this-&gt;format_deflist(array('text' =&gt; $stickybuff));
01163         <span class="keywordflow">if</span> ($dl_out) { $out .= $dl_out; }
01164       }
01165     }
01166 
01167     <span class="comment">// cleanup-- restore preserved blocks</span>
01168     <span class="keywordflow">for</span> ($i = count($this-&gt;repl[0]); $i &gt; 0; $i--) {
01169       $out = preg_replace('!(?:&lt;|&amp;lt;)textile#' . $i . '(?:&gt;|&amp;gt;)!', $this-&gt;repl[0][$i - 1], $out, 1);
01170     }
01171     array_shift($this-&gt;repl);
01172 
01173     <span class="comment">// scan for br, hr tags that are not closed and close them</span>
01174     <span class="comment">// only for xhtml! just the common ones -- don't fret over input</span>
01175     <span class="comment">// and the like.</span>
01176     <span class="keywordflow">if</span> (preg_match('/^xhtml/i', $this-&gt;flavor())) {
01177       $out = preg_replace('/(&lt;(?:img|br|hr)[^&gt;]*?(?&lt;!\/))&gt;/', '$1 /&gt;', $out);
01178     }
01179 
01180     <span class="keywordflow">return</span> $out;
01181   } <span class="comment">// function process</span>
01182 
<a name="l01202"></a><a class="code" href="classTextile.html#d1">01202</a>   function format_paragraph($args) {
01203     $buffer = ($args['text'] ? $args['text'] : '');
01204 
01205     array_unshift($this-&gt;repl, array());
01206     $buffer = preg_replace_callback('{(?:^|(?&lt;=[\s&gt;])|([{[]))
01207                                       ==(.+?)==
01208                                       (?:$|([\]}])|(?=' . $this-&gt;punct . '{1,2}|\s))}sx',
01209                                     $this-&gt;_cb('$me-&gt;_repl($me-&gt;repl[0], $me-&gt;format_block(array(<span class="stringliteral">"text"</span> =&gt; $m[2], <span class="stringliteral">"inline"</span> =&gt; 1, <span class="stringliteral">"pre"</span> =&gt; $m[1], <span class="stringliteral">"post"</span> =&gt; $m[3])))'), $buffer);
01210 
01211     unset($tokens);
01212     <span class="keywordflow">if</span> (preg_match('/&lt;/', $buffer) &amp;&amp; (!$this-&gt;disable_html())) {  <span class="comment">// optimization -- no point in tokenizing if we</span>
01213                                        <span class="comment">// have no tags to tokenize</span>
01214       $tokens = $this-&gt;_tokenize($buffer);
01215     } <span class="keywordflow">else</span> {
01216       $tokens = array(array('text', $buffer));
01217     }
01218     $result = '';
01219     foreach ($tokens as $token) {
01220       $text = $token[1];
01221       <span class="keywordflow">if</span> ($token[0] == 'tag') {
01222         $text = preg_replace('/&amp;(?!amp;)/', '&amp;amp;', $text);
01223         $result .= $text;
01224       } <span class="keywordflow">else</span> {
01225         $text = $this-&gt;format_inline(array('text' =&gt; $text));
01226         $result .= $text;
01227       }
01228     }
01229 
01230     <span class="comment">// now, add line breaks for lines that contain plaintext</span>
01231     $lines = preg_split('/\n/', $result);
01232     $result = '';
01233     $needs_closing = 0;
01234     foreach ($lines as $line) {
01235       <span class="keywordflow">if</span> (!preg_match('{(' . $this-&gt;blocktags . ')}x', $line)
01236           &amp;&amp; ((preg_match('/^[^&lt;]/', $line) || preg_match('/&gt;[^&lt;]/', $line))
01237               || !preg_match('/&lt;img /', $line))) {
01238         <span class="keywordflow">if</span> ($this-&gt;options['_line_open']) {
01239           <span class="keywordflow">if</span> ($result != '') { $result .= <span class="stringliteral">"\n"</span>; }
01240           $result .= $this-&gt;options['_line_open'] . $line . $this-&gt;options['_line_close'];
01241         } <span class="keywordflow">else</span> {
01242           <span class="keywordflow">if</span> ($needs_closing) {
01243             $result .= $this-&gt;options['_line_close'] . <span class="stringliteral">"\n"</span>;
01244           } <span class="keywordflow">else</span> {
01245             $needs_closing = 1;
01246             <span class="keywordflow">if</span> ($result != '') { $result .= <span class="stringliteral">"\n"</span>; }
01247           }
01248           $result .= $line;
01249         }
01250       } <span class="keywordflow">else</span> {
01251         <span class="keywordflow">if</span> ($needs_closing) {
01252           $result .= $this-&gt;options['_line_close'] . <span class="stringliteral">"\n"</span>;
01253         } <span class="keywordflow">else</span> {
01254           <span class="keywordflow">if</span> ($result != '') { $result .= <span class="stringliteral">"\n"</span>; }
01255         }
01256         $result .= $line;
01257         $needs_closing = 0;
01258       }
01259     }
01260 
01261     <span class="comment">// at this point, we will restore the \001's to \n's (reversing</span>
01262     <span class="comment">// the step taken in _tokenize).</span>
01263     <span class="comment">//$result = preg_replace('/\r/', "\n", $result);</span>
01264     $result = preg_replace('/\001/', <span class="stringliteral">"\n"</span>, $result);
01265 
01266     <span class="keywordflow">for</span> ($i = count($this-&gt;repl[0]); $i &gt; 0; $i--) {
01267       $result = preg_replace(<span class="stringliteral">"|&lt;textile#$i&gt;|"</span>, $this-&gt;repl[0][$i - 1], $result, 1);
01268     }
01269     array_shift($this-&gt;repl);
01270 
01271     <span class="comment">// quotalize</span>
01272     <span class="keywordflow">if</span> ($this-&gt;options['do_quotes']) {
01273       $result = $this-&gt;process_quotes($result);
01274     }
01275 
01276     <span class="keywordflow">return</span> $result;
01277   } <span class="comment">// function format_paragraph</span>
01278 
<a name="l01298"></a><a class="code" href="classTextile.html#d2">01298</a>   function format_inline($args) {
01299     $qtags = array(array('**', <span class="charliteral">'b'</span>,      '(?&lt;!\*)\*\*(?!\*)', <span class="charliteral">'\*'</span>),
01300                    array('__', <span class="charliteral">'i'</span>,      '(?&lt;!_)__(?!_)', <span class="charliteral">'_'</span>),
01301                    array('??', 'cite',   '\?\?(?!\?)', <span class="charliteral">'\?'</span>),
01302                    array(<span class="charliteral">'*'</span>,  'strong', '(?&lt;!\*)\*(?!\*)', <span class="charliteral">'\*'</span>),
01303                    array(<span class="charliteral">'_'</span>,  'em',     '(?&lt;!_)_(?!_)', <span class="charliteral">'_'</span>),
01304                    array(<span class="charliteral">'-'</span>,  'del',    '(?&lt;!\-)\-(?!\-)', <span class="charliteral">'-'</span>),
01305                    array(<span class="charliteral">'+'</span>,  'ins',    '(?&lt;!\+)\+(?!\+)', <span class="charliteral">'\+'</span>),
01306                    array('++', 'big',    '(?&lt;!\+)\+\+(?!\+)', '\+\+'),
01307                    array('--', 'small',  '(?&lt;!\-)\-\-(?!\-)', '\-\-'),
01308                    array(<span class="charliteral">'~'</span>,  'sub',    '(?&lt;!\~)\~(?![\\\\/~])', <span class="charliteral">'\~'</span>));
01309     $text = ($args['text'] ? $args['text'] : '');
01310 
01311     array_unshift($this-&gt;repl, array());
01312 
01313     $text = preg_replace_callback(<span class="charliteral">'{'</span> . $this-&gt;codere . '}mx', $this-&gt;_cb('$me-&gt;_repl($me-&gt;repl[0], $me-&gt;format_code(array(<span class="stringliteral">"text"</span> =&gt; $m[2] . $m[4], <span class="stringliteral">"lang"</span> =&gt; $m[1] . $m[3])))'), $text);
01314 
01315     <span class="comment">// images must be processed before encoding the text since they might</span>
01316     <span class="comment">// have the &lt;, &gt; alignment specifiers...</span>
01317 
01318     <span class="comment">// !blah (alt)! -&gt; image</span>
01319     $text = preg_replace_callback('{(?:^|(?&lt;=[\s&gt;])|([{[]))      # $1: open brace/bracket
01320                                     !                            # opening
01321                                     (' . $this-&gt;imgalignre . '?) # $2: optional alignment
01322                                     (' . $this-&gt;clstypadre . '*) # $3: optional CSS <span class="keyword">class</span>/id
01323                                     (' . $this-&gt;imgalignre . '?) # $4: optional alignment
01324                                     (?:\s*)                      # space between alignment/css stuff
01325                                     ([^\s\(!]+)                  # $5: filename
01326                                     (\s*[^\(!]*(?:\([^\)]+\))?[^!]*) # $6: extras (alt text)
01327                                     !                            # closing
01328                                     (?::(\d+|' . $this-&gt;urlre . '))? # $7: optional URL
01329                                     (?:$|([\]}])|(?=' . $this-&gt;punct . '{1,2}|\s)) # $8: closing brace/bracket
01330                                    }mx', $this-&gt;_cb('$me-&gt;_repl($me-&gt;repl[0], $me-&gt;format_image(array(<span class="stringliteral">"pre"</span> =&gt; $m[1], <span class="stringliteral">"src"</span> =&gt; $m[5], <span class="stringliteral">"align"</span> =&gt; ($m[2] ? $m[2] : $m[4]), <span class="stringliteral">"extra"</span> =&gt; $m[6], <span class="stringliteral">"url"</span> =&gt; $m[7], <span class="stringliteral">"clsty"</span> =&gt; $m[3], <span class="stringliteral">"post"</span> =&gt; $m[8])))'), $text);
01331 
01332     $text = preg_replace_callback('{(?:^|(?&lt;=[\s&gt;])|([{[]))     # $1: open brace/bracket
01333                                     %                           # opening
01334                                     (' . $this-&gt;halignre . '?)  # $2: optional alignment
01335                                     (' . $this-&gt;clstyre . '*)   # $3: optional CSS <span class="keyword">class</span>/id
01336                                     (' . $this-&gt;halignre . '?)  # $4: optional alignment
01337                                     (?:\s*)                     # spacing
01338                                     ([^%]+?)                    # $5: text
01339                                     %                           # closing
01340                                     (?::(\d+|' . $this-&gt;urlre . '))? # $6: optional URL
01341                                     (?:$|([]}])|(?=' . $this-&gt;punct . '{1,2}|\s)) # $7: closing brace/bracket
01342                                    }mx', $this-&gt;_cb('$me-&gt;_repl($me-&gt;repl[0], $me-&gt;format_span(array(<span class="stringliteral">"pre"</span> =&gt; $m[1], <span class="stringliteral">"text"</span> =&gt; $m[5], <span class="stringliteral">"align"</span> =&gt; ($m[2] ? $m[2] : $m[4]), <span class="stringliteral">"cite"</span> =&gt; $m[6], <span class="stringliteral">"clsty"</span> =&gt; $m[3], <span class="stringliteral">"post"</span> =&gt; $m[7])))'), $text);
01343 
01344     $text = $this-&gt;encode_html($text);
01345     $text = preg_replace('!&amp;lt;textile#(\d+)&amp;gt;!', '&lt;textile#$1&gt;', $text);
01346     $text = preg_replace('!&amp;amp;quot;!', '&amp;#34;', $text);
01347     $text = preg_replace('!&amp;amp;(([a-z]+|#\d+);)!', '&amp;$1', $text);
01348     $text = preg_replace('!&amp;quot;!', <span class="charliteral">'"'</span>, $text);
01349 
01350     <span class="comment">// These create markup with entities. Do first and 'save' result for later:</span>
01351     <span class="comment">// "text":url -&gt; hyperlink</span>
01352     <span class="comment">// links with brackets surrounding</span>
01353     $parenre = '\( (?: [^()] )* \)';
01354     $text = preg_replace_callback('{(
01355                                     [{[]
01356                                     (?:
01357                                         (?:<span class="stringliteral">"                                         # quote character</span>
01358 <span class="stringliteral">                                           (' . $this-&gt;clstyre . '*)?                # $2: optional CSS class/id</span>
01359 <span class="stringliteral">                                           ([^"</span>]+?)                                  # $3: link text
01360                                            (?:\( ( (?:[^()]|' . $parenre . ')*) \))? # $4: optional link title
01361                                            <span class="stringliteral">"                                         # closing quote</span>
01362 <span class="stringliteral">                                        )</span>
01363 <span class="stringliteral">                                        |</span>
01364 <span class="stringliteral">                                        (?:\'                                        # open single quote</span>
01365 <span class="stringliteral">                                           (' . $this-&gt;clstyre . '*)?                # $5: optional CSS class/id</span>
01366 <span class="stringliteral">                                           ([^\']+?)                                 # $6: link text</span>
01367 <span class="stringliteral">                                           (?:\( ( (?:[^()]|' . $parenre . ')*) \))? # $7: optional link title</span>
01368 <span class="stringliteral">                                           \'                                        # closing quote</span>
01369 <span class="stringliteral">                                        )</span>
01370 <span class="stringliteral">                                    )</span>
01371 <span class="stringliteral">                                    :(.+?)                                           # $8: URL suffix</span>
01372 <span class="stringliteral">                                    [\]}]</span>
01373 <span class="stringliteral">                                   )</span>
01374 <span class="stringliteral">                                   }mx', $this-&gt;_cb('$me-&gt;_repl($me-&gt;repl[0], $me-&gt;format_link(array("</span>text<span class="stringliteral">" =&gt; $m[1], "</span>linktext<span class="stringliteral">" =&gt; $m[3] . $m[6], "</span>title<span class="stringliteral">" =&gt; $me-&gt;encode_html_basic($m[4] . $m[7]), "</span>url<span class="stringliteral">" =&gt; $m[8], "</span>clsty<span class="stringliteral">" =&gt; $m[2] . $m[5])))'), $text);</span>
01375 <span class="stringliteral"></span>
01376 <span class="stringliteral">    $text = preg_replace_callback('{((?:^|(?&lt;=[\s&gt;\(]))                              # $1: open brace/bracket</span>
01377 <span class="stringliteral">                                    (?: (?:"</span>                                         # quote character <span class="stringliteral">"</span>
01378 <span class="stringliteral">                                           (' . $this-&gt;clstyre . '*)?                # $2: optional CSS class/id</span>
01379 <span class="stringliteral">                                           ([^"</span>]+?)                                  # $3: link text <span class="stringliteral">"</span>
01380 <span class="stringliteral">                                           (?:\( ( (?:[^()]|' . $parenre . ')*) \))? # $4: optional link title</span>
01381 <span class="stringliteral">                                           "</span>                                         # closing quote # <span class="stringliteral">"</span>
01382 <span class="stringliteral">                                        )</span>
01383 <span class="stringliteral">                                        |</span>
01384 <span class="stringliteral">                                        (?:\'                                        # open single quote \'</span>
01385 <span class="stringliteral">                                           (' . $this-&gt;clstyre . '*)?                # $5: optional CSS class/id</span>
01386 <span class="stringliteral">                                           ([^\']+?)                                 # $6: link text \'</span>
01387 <span class="stringliteral">                                           (?:\( ( (?:[^()]|' . $parenre . ')*) \))? # $7: optional link title</span>
01388 <span class="stringliteral">                                           \'                                        # closing quote \'</span>
01389 <span class="stringliteral">                                        )</span>
01390 <span class="stringliteral">                                    )</span>
01391 <span class="stringliteral">                                    :(\d+|' . $this-&gt;urlre . ')                      # $8: URL suffix</span>
01392 <span class="stringliteral">                                    (?:$|(?=' . $this-&gt;punct . '{1,2}|\s)))          # $9: closing brace/bracket</span>
01393 <span class="stringliteral">                                   }mx', $this-&gt;_cb('$me-&gt;_repl($me-&gt;repl[0], $me-&gt;format_link(array("</span>text<span class="stringliteral">" =&gt; $m[1], "</span>linktext<span class="stringliteral">" =&gt; $m[3] . $m[6], "</span>title<span class="stringliteral">" =&gt; $me-&gt;encode_html_basic($m[4] . $m[7]), "</span>url<span class="stringliteral">" =&gt; $m[8], "</span>clsty<span class="stringliteral">" =&gt; $m[2] . $m[5])))'), $text);</span>
01394 <span class="stringliteral"></span>
01395 <span class="stringliteral">    if (preg_match('/^xhtml2/', $this-&gt;flavor())) {</span>
01396 <span class="stringliteral">      // citation with cite link</span>
01397 <span class="stringliteral">      $text = preg_replace_callback('{(?:^|(?&lt;=[\s&gt;\'"</span>\(])|([{[]))                   # $1: open brace/bracket \'
01398                                       \?\?                                           # opening \'??\'
01399                                       ([^\?]+?)                                      # $2: characters (can\'t contain \'?\')
01400                                       \?\?                                           # closing \'??\'
01401                                       :(\d+|' . $this-&gt;urlre . ')                    # $3: optional citation URL
01402                                       (?:$|([\]}])|(?=' . $this-&gt;punct . '{1,2}|\s)) # $4: closing brace/bracket
01403                                      }mx', $this-&gt;_cb('$me-&gt;_repl($me-&gt;repl[0], $me-&gt;format_cite(array(<span class="stringliteral">"pre"</span> =&gt; $m[1], <span class="stringliteral">"text"</span> =&gt; $m[2], <span class="stringliteral">"cite"</span> =&gt; $m[3], <span class="stringliteral">"post"</span> =&gt; $m[4])))'), $text);
01404     }
01405 
01406     <span class="comment">// footnotes</span>
01407     <span class="keywordflow">if</span> (preg_match('/[^ ]\[\d+\]/', $text)) {
01408       $fntag = '&lt;sup';
01409       <span class="keywordflow">if</span> ($this-&gt;options['css']['class_footnote']) { $fntag .= ' <span class="keyword">class</span>=<span class="stringliteral">"' . $this-&gt;options['css']['class_footnote'] . '"</span>'; }
01410       $fntag .= '&gt;&lt;a href=<span class="stringliteral">"#' . ($this-&gt;options['css']['id_footnote_prefix'] ? $this-&gt;options['css']['id_footnote_prefix'] : 'fn');</span>
01411 <span class="stringliteral">      $text = preg_replace('|([^ ])\[(\d+)\]|', '$1' . $fntag . '$2"</span>&gt;$2&lt;/a&gt;&lt;/sup&gt;', $text);
01412     }
01413 
01414     <span class="comment">// translate macros:</span>
01415     $text = preg_replace_callback('{(\{)(.+?)(\})}x',
01416                                   $this-&gt;_cb('$me-&gt;format_macro(array(<span class="stringliteral">"pre"</span> =&gt; $m[1], <span class="stringliteral">"post"</span> =&gt; $m[3], <span class="stringliteral">"macro"</span> =&gt; $m[2]))'), $text);
01417 
01418     <span class="comment">// these were present with textile 1 and are common enough</span>
01419     <span class="comment">// to not require macro braces...</span>
01420     <span class="comment">// (tm) -&gt; &amp;trade;</span>
01421     $text = preg_replace('|[\(\[]TM[\)\]]|i', '&amp;#8482;', $text);
01422     <span class="comment">// (c) -&gt; &amp;copy;</span>
01423     $text = preg_replace('|[\(\[]C[\)\]]|i', '&amp;#169;', $text);
01424     <span class="comment">// (r) -&gt; &amp;reg;</span>
01425     $text = preg_replace('|[\(\[]R[\)\]]|i', '&amp;#174;', $text);
01426 
01427     <span class="keywordflow">if</span> ($this-&gt;preserve_spaces()) {
01428       <span class="comment">// replace two spaces with an em space</span>
01429       $text = preg_replace('/(?&lt;!\s)\ \ (?!=\s)/', '&amp;#8195;', $text);
01430     }
01431 
01432     $redo = preg_match('/[\*_\?\-\+\^\~]/', $text);
01433     $last = $text;
01434     <span class="keywordflow">while</span> ($redo) {
01435       <span class="comment">// simple replacements...</span>
01436       $redo = 0;
01437       foreach ($qtags as $tag) {
01438         list ($this-&gt;tmp[<span class="charliteral">'f'</span>][], $this-&gt;tmp[<span class="charliteral">'r'</span>][], $qf, $cls) = $tag;
01439         <span class="keywordflow">if</span> ($last != ($text = preg_replace_callback('{(?:^|(?&lt;=[\s&gt;\'<span class="stringliteral">"])|([{[]))                     # "</span>\' $1 - pre
01440                                                       ' . $qf . '                                    #
01441                                                       (?:(' . $this-&gt;clstyre . '*))?                 # $2 - attributes
01442                                                       ([^' . $cls . '\s].*?)                         # $3 - content
01443                                                       (?&lt;=\S)' . $qf . '                             #
01444                                                       (?:$|([\]}])|(?=' . $this-&gt;punct . '{1,2}|\s)) # $4 - post
01445                                                      }mx', $this-&gt;_cb('$me-&gt;format_tag(array(<span class="stringliteral">"tag"</span> =&gt; end($me-&gt;tmp[<span class="stringliteral">"r"</span>]), <span class="stringliteral">"marker"</span> =&gt; end($me-&gt;tmp[<span class="stringliteral">"f"</span>]), <span class="stringliteral">"pre"</span> =&gt; $m[1], <span class="stringliteral">"text"</span> =&gt; $m[3], <span class="stringliteral">"clsty"</span> =&gt; $m[2], <span class="stringliteral">"post"</span> =&gt; $m[4]))'), $text))) {
01446           $redo = ($redo || ($last != $text));
01447           $last = $text;
01448         }
01449         array_pop($this-&gt;tmp[<span class="charliteral">'f'</span>]); array_pop($this-&gt;tmp[<span class="charliteral">'r'</span>]);
01450       }
01451     }
01452 
01453     <span class="comment">// superscript is an even simpler replacement...</span>
01454     $text = preg_replace('/(?&lt;!\^)\^(?!\^)(.+?)(?&lt;!\^)\^(?!\^)/', '&lt;sup&gt;$1&lt;/sup&gt;', $text);
01455 
01456     <span class="comment">// ABC(Aye Bee Cee) -&gt; acronym</span>
01457     $text = preg_replace_callback('{\b([A-Z][A-Za-z0-9]*?[A-Z0-9]+?)\b(?:[(]([^)]*)[)])}',
01458                                   $this-&gt;_cb('$me-&gt;_repl($me-&gt;repl[0],<span class="stringliteral">"&lt;acronym title=\""</span> . $me-&gt;encode_html_basic($m[2]) . <span class="stringliteral">"\"&gt;$m[1]&lt;/acronym&gt;"</span>)'), $text);
01459 
01460     <span class="comment">// ABC -&gt; 'capped' span</span>
01461     <span class="keywordflow">if</span> ($this-&gt;tmp['caps'][] = $this-&gt;options['css']['class_caps']) {
01462       $text = preg_replace_callback('/(^|[^<span class="stringliteral">"][&gt;\s])  # "</span>
01463                                       ((?:[A-Z](?:[A-Z0-9\.,\']|\&amp;amp;){2,}\ *)+?) # \'
01464                                       (?=[^A-Z\.0-9]|$)
01465                                      /mx', $this-&gt;_cb('$m[1] . $me-&gt;_repl($me-&gt;repl[0], <span class="stringliteral">"&lt;span class=\""</span> . end($me-&gt;tmp[<span class="stringliteral">"caps"</span>]) . <span class="stringliteral">"\"&gt;$m[2]&lt;/span&gt;"</span>)'), $text);
01466     }
01467     array_pop($this-&gt;tmp['caps']);
01468 
01469     <span class="comment">// nxn -&gt; n&amp;times;n</span>
01470     $text = preg_replace('!((?:[0-9\.]0|[1-9]|\d[\'<span class="stringliteral">"])\ ?)x(\ ?\d)!', '$1&amp;#215;$2', $text);</span>
01471 <span class="stringliteral"></span>
01472 <span class="stringliteral">    // translate these entities to the Unicode equivalents:</span>
01473 <span class="stringliteral">    $text = preg_replace('/&amp;#133;/', '&amp;#8230;', $text);</span>
01474 <span class="stringliteral">    $text = preg_replace('/&amp;#145;/', '&amp;#8216;', $text);</span>
01475 <span class="stringliteral">    $text = preg_replace('/&amp;#146;/', '&amp;#8217;', $text);</span>
01476 <span class="stringliteral">    $text = preg_replace('/&amp;#147;/', '&amp;#8220;', $text);</span>
01477 <span class="stringliteral">    $text = preg_replace('/&amp;#148;/', '&amp;#8221;', $text);</span>
01478 <span class="stringliteral">    $text = preg_replace('/&amp;#150;/', '&amp;#8211;', $text);</span>
01479 <span class="stringliteral">    $text = preg_replace('/&amp;#151;/', '&amp;#8212;', $text);</span>
01480 <span class="stringliteral"></span>
01481 <span class="stringliteral">    // Restore replacements done earlier:</span>
01482 <span class="stringliteral">    for ($i = count($this-&gt;repl[0]); $i &gt; 0; $i--) {</span>
01483 <span class="stringliteral">      $text = preg_replace("</span>|&lt;textile#$i&gt;|<span class="stringliteral">", $this-&gt;repl[0][$i - 1], $text);</span>
01484 <span class="stringliteral">    }</span>
01485 <span class="stringliteral">    array_shift($this-&gt;repl);</span>
01486 <span class="stringliteral"></span>
01487 <span class="stringliteral">    // translate entities to characters for highbit stuff since</span>
01488 <span class="stringliteral">    // we're using utf8</span>
01489 <span class="stringliteral">    // removed for backward compatability with older versions of Perl</span>
01490 <span class="stringliteral">    //if (preg_match('/^utf-?8$/i', $this-&gt;options['charset'])) {</span>
01491 <span class="stringliteral">    //    // translate any unicode entities to native UTF-8</span>
01492 <span class="stringliteral">    //    $text = preg_replace('/\&amp;\#(\d+);/e', '($1 &gt; 127) ? pack('U', $1) : chr($1)', $text);</span>
01493 <span class="stringliteral">    //}</span>
01494 <span class="stringliteral"></span>
01495 <span class="stringliteral">    return $text;</span>
01496 <span class="stringliteral">  } // function format_inline</span>
01497 <span class="stringliteral"></span>
<a name="l01530"></a><a class="code" href="classTextile.html#d3">01530</a> <span class="stringliteral">  function format_macro($attrs) {</span>
01531 <span class="stringliteral">    $macro = $attrs['macro'];</span>
01532 <span class="stringliteral">    if ($this-&gt;options['macros'][$macro]) {</span>
01533 <span class="stringliteral">      return $this-&gt;options['macros'][$macro];</span>
01534 <span class="stringliteral">    }</span>
01535 <span class="stringliteral"></span>
01536 <span class="stringliteral">    return $attrs['pre'] . $macro . $attrs['post'];</span>
01537 <span class="stringliteral">  } // function format_macro</span>
01538 <span class="stringliteral"></span>
<a name="l01570"></a><a class="code" href="classTextile.html#d4">01570</a> <span class="stringliteral">  function format_cite($args) {</span>
01571 <span class="stringliteral">    $pre = ($args['pre'] ? $args['pre'] : '');</span>
01572 <span class="stringliteral">    $text = ($args['text'] ? $args['text'] : '');</span>
01573 <span class="stringliteral">    $cite = $args['cite'];</span>
01574 <span class="stringliteral">    $post = ($args['post'] ? $args['post'] : '');</span>
01575 <span class="stringliteral">    $this-&gt;_strip_borders($pre, $post);</span>
01576 <span class="stringliteral">    $tag = $pre . '&lt;cite';</span>
01577 <span class="stringliteral">    if (preg_match('/^xhtml2/', $this-&gt;flavor()) &amp;&amp; $cite) {</span>
01578 <span class="stringliteral">      $cite = $this-&gt;format_url(array('url' =&gt; $cite));</span>
01579 <span class="stringliteral">      $tag .= "</span> cite=\<span class="stringliteral">"$cite\""</span>;
01580     } <span class="keywordflow">else</span> {
01581       $post .= <span class="charliteral">':'</span>;
01582     }
01583     $tag .= <span class="charliteral">'&gt;'</span>;
01584     <span class="keywordflow">return</span> $tag . $this-&gt;format_inline(array('text' =&gt; $text)) . '&lt;/cite&gt;' . $post;
01585   } <span class="comment">// function format_cite</span>
01586 
<a name="l01610"></a><a class="code" href="classTextile.html#d5">01610</a>   function format_code($args) {
01611     $code = ($args['text'] ? $args['text'] : '');
01612     $lang = $args['lang'];
01613     $code = $this-&gt;encode_html($code, 1);
01614     $code = preg_replace('/&amp;lt;textile#(\d+)&amp;gt;/', '&lt;textile#$1&gt;', $code);
01615     $tag = '&lt;code';
01616     <span class="keywordflow">if</span> ($lang) { $tag .= <span class="stringliteral">" language=\"$lang\""</span>; }
01617     <span class="keywordflow">return</span> $tag . <span class="charliteral">'&gt;'</span> . $code . '&lt;/code&gt;';
01618   } <span class="comment">// function format_code</span>
01619 
<a name="l01662"></a><a class="code" href="classTextile.html#d6">01662</a>   function format_classstyle($clsty = NULL, $<span class="keyword">class</span> = NULL, $style = NULL) {
01663     $class = preg_replace('/^ /', '', $<span class="keyword">class</span>, 1);
01664 
01665     unset($lang, $padleft, $padright, $<span class="keywordtype">id</span>);
01666     <span class="keywordflow">if</span> ($clsty &amp;&amp; preg_match('/{([^}]+)}/', $clsty, $matches)) {
01667       $_style = $matches[1];
01668       $_style = preg_replace('/\n/', <span class="charliteral">' '</span>, $_style);
01669       $style .= <span class="charliteral">';'</span> . $_style;
01670       $clsty = preg_replace('/{[^}]+}/', '', $clsty);
01671     }
01672     <span class="keywordflow">if</span> ($clsty &amp;&amp; (preg_match('/\(([A-Za-z0-9_\- ]+?)(?:#(.+?))?\)/', $clsty, $matches) ||
01673                    preg_match('/\(([A-Za-z0-9_\- ]+?)?(?:#(.+?))\)/', $clsty, $matches))) {
01674       <span class="keywordflow">if</span> ($matches[1] || $matches[2]) {
01675         <span class="keywordflow">if</span> ($class) {
01676           $class = $matches[1] . <span class="charliteral">' '</span> . $class;
01677         } <span class="keywordflow">else</span> {
01678           $class = $matches[1];
01679         }
01680         $id = $matches[2];
01681         <span class="keywordflow">if</span> ($class) {
01682           $clsty = preg_replace('/\([A-Za-z0-9_\- ]+?(#.*?)?\)/', '', $clsty);
01683         }
01684         <span class="keywordflow">if</span> ($id) {
01685           $clsty = preg_replace('/\(#.+?\)/', '', $clsty);
01686         }
01687       }
01688     }
01689     <span class="keywordflow">if</span> ($clsty &amp;&amp; preg_match('/(\(+)/', $clsty, $matches)) {
01690       $padleft = strlen($matches[1]);
01691       $clsty = preg_replace('/\(+/', '', $clsty, 1);
01692     }
01693     <span class="keywordflow">if</span> ($clsty &amp;&amp; preg_match('/(\)+)/', $clsty, $matches)) {
01694       $padright = strlen($matches[1]);
01695       $clsty = preg_replace('/\)+/', '', $clsty, 1);
01696     }
01697     <span class="keywordflow">if</span> ($clsty &amp;&amp; preg_match('/\[(.+?)\]/', $clsty, $matches)) {
01698       $lang = $matches[1];
01699       $clsty = preg_replace('/\[.+?\]/', '', $clsty);
01700     }
01701     $attrs = '';
01702     <span class="keywordflow">if</span> ($padleft) { $style .= <span class="stringliteral">";padding-left:${padleft}em"</span>; }
01703     <span class="keywordflow">if</span> ($padright) { $style .= <span class="stringliteral">";padding-right:${padright}em"</span>; }
01704     $style = preg_replace('/^;/', '', $style, 1);
01705     $class = preg_replace('/^ /', '', $<span class="keyword">class</span>, 1);
01706     $class = preg_replace('/ $/', '', $<span class="keyword">class</span>, 1);
01707     <span class="keywordflow">if</span> ($class) { $attrs .= <span class="stringliteral">" class=\"$class\""</span>; }
01708     <span class="keywordflow">if</span> ($id) { $attrs .= <span class="stringliteral">" id=\"$id\""</span>; }
01709     <span class="keywordflow">if</span> ($style) { $attrs .= <span class="stringliteral">" style=\"$style\""</span>; }
01710     <span class="keywordflow">if</span> ($lang) { $attrs .= <span class="stringliteral">" lang=\"$lang\""</span>; }
01711     $attrs = preg_replace('/^ /', '', $attrs, 1);
01712     <span class="keywordflow">return</span> $attrs;
01713   } <span class="comment">// function format_classstyle</span>
01714 
<a name="l01749"></a><a class="code" href="classTextile.html#d7">01749</a>   function format_tag($args) {
01750     $tagname = $args['tag'];
01751     $text = ($args['text'] ? $args['text'] : '');
01752     $pre = ($args['pre'] ? $args['pre'] : '');
01753     $post = ($args['post'] ? $args['post'] : '');
01754     $clsty = ($args['clsty'] ? $args['clsty'] : '');
01755     $this-&gt;_strip_borders($pre, $post);
01756     $tag = <span class="stringliteral">"&lt;$tagname"</span>;
01757     $attr = $this-&gt;format_classstyle($clsty);
01758     <span class="keywordflow">if</span> ($attr) { $tag .= <span class="stringliteral">" $attr"</span>; }
01759     $tag .= <span class="stringliteral">"&gt;$text&lt;/$tagname&gt;"</span>;
01760     <span class="keywordflow">return</span> $pre . $tag . $post;
01761   } <span class="comment">// function format_tag</span>
01762 
<a name="l01782"></a><a class="code" href="classTextile.html#d8">01782</a>   function format_deflist($args) {
01783     $str = ($args['text'] ? $args['text'] : '');
01784     unset($clsty);
01785     $lines = preg_split('/\n/', $str);
01786     <span class="keywordflow">if</span> (preg_match('{^(dl(' . $this-&gt;clstyre . '*?)\.\.?(?:\ +|$))}x', $lines[0], $matches)) {
01787       $clsty = $matches[2];
01788       $lines[0] = substr($lines[0], strlen($matches[1]));
01789     }
01790 
01791     unset($dt, $dd);
01792     $out = '';
01793     foreach ($lines as $line) {
01794       <span class="keywordflow">if</span> (preg_match('{^((?:' . $this-&gt;clstyre . '*)(?:[^\ ].*?)(?&lt;![<span class="stringliteral">"\'\ ])):([^\ \/].*)$}x', $line, $matches)) {</span>
01795 <span class="stringliteral">        if ($dt &amp;&amp; $dd) { $out .= $this-&gt;add_term($dt, $dd); }</span>
01796 <span class="stringliteral">        $dt = $matches[1];</span>
01797 <span class="stringliteral">        $dd = $matches[2];</span>
01798 <span class="stringliteral">      } else {</span>
01799 <span class="stringliteral">        $dd .= "</span>\n<span class="stringliteral">" . $line;</span>
01800 <span class="stringliteral">      }</span>
01801 <span class="stringliteral">    }</span>
01802 <span class="stringliteral">    if ($dt &amp;&amp; $dd) { $out .= $this-&gt;add_term($dt, $dd); }</span>
01803 <span class="stringliteral"></span>
01804 <span class="stringliteral">    $tag = '&lt;dl';</span>
01805 <span class="stringliteral">    if ($clsty) { $attr = $this-&gt;format_classstyle($clsty); }</span>
01806 <span class="stringliteral">    if ($attr) { $tag .= "</span> $attr<span class="stringliteral">"; }</span>
01807 <span class="stringliteral">    $tag .= '&gt;' . "</span>\n<span class="stringliteral">";</span>
01808 <span class="stringliteral"></span>
01809 <span class="stringliteral">    return $tag . $out . "</span>&lt;/dl&gt;\n<span class="stringliteral">";</span>
01810 <span class="stringliteral">  } // function format_deflist</span>
01811 <span class="stringliteral"></span>
<a name="l01824"></a><a class="code" href="classTextile.html#d9">01824</a> <span class="stringliteral">  function add_term($dt, $dd) {</span>
01825 <span class="stringliteral">    unset($dtattr, $ddattr);</span>
01826 <span class="stringliteral">    unset($dtlang);</span>
01827 <span class="stringliteral">    if (preg_match('{^(' . $this-&gt;clstyre . '*)}x', $dt, $matches)) {</span>
01828 <span class="stringliteral">      $param = $matches[1];</span>
01829 <span class="stringliteral">      $dtattr = $this-&gt;format_classstyle($param);</span>
01830 <span class="stringliteral">      if (preg_match('/\[([A-Za-z]+?)\]/', $param, $matches)) {</span>
01831 <span class="stringliteral">        $dtlang = $matches[1];</span>
01832 <span class="stringliteral">      }</span>
01833 <span class="stringliteral">      $dt = substr($dt, strlen($param));</span>
01834 <span class="stringliteral">    }</span>
01835 <span class="stringliteral">    if (preg_match('{^(' . $this-&gt;clstyre . '*)}x', $dd, $matches)) {</span>
01836 <span class="stringliteral">      $param = $matches[1];</span>
01837 <span class="stringliteral">      // if the language was specified for the term,</span>
01838 <span class="stringliteral">      // then apply it to the definition as well (unless</span>
01839 <span class="stringliteral">      // already specified of course)</span>
01840 <span class="stringliteral">      if ($dtlang &amp;&amp; preg_match('/\[([A-Za-z]+?)\]/', $param)) {</span>
01841 <span class="stringliteral">        unset($dtlang);</span>
01842 <span class="stringliteral">      }</span>
01843 <span class="stringliteral">      $ddattr = $this-&gt;format_classstyle(($dtlang ? "</span>[$dtlang]<span class="stringliteral">" : '') . $param);</span>
01844 <span class="stringliteral">      $dd = substr($dd, strlen($param));</span>
01845 <span class="stringliteral">    }</span>
01846 <span class="stringliteral">    $out = '&lt;dt';</span>
01847 <span class="stringliteral">    if ($dtattr) { $out .= "</span> $dtattr<span class="stringliteral">"; }</span>
01848 <span class="stringliteral">    $out .= '&gt;' . $this-&gt;format_inline(array('text' =&gt; $dt)) . '&lt;/dt&gt;' . "</span>\n<span class="stringliteral">";</span>
01849 <span class="stringliteral">    if (preg_match('/\n\n/', $dd)) {</span>
01850 <span class="stringliteral">      if (preg_match('/\n\n/', $dd)) { $dd = $this-&gt;process($dd); }</span>
01851 <span class="stringliteral">    } else {</span>
01852 <span class="stringliteral">      $dd = $this-&gt;format_paragraph(array('text' =&gt; $dd));</span>
01853 <span class="stringliteral">    }</span>
01854 <span class="stringliteral">    $out .= '&lt;dd';</span>
01855 <span class="stringliteral">    if ($ddattr) { $out .= "</span> $ddattr<span class="stringliteral">"; }</span>
01856 <span class="stringliteral">    $out .= '&gt;' . $dd . '&lt;/dd&gt;' . "</span>\n<span class="stringliteral">";</span>
01857 <span class="stringliteral">    return $out;</span>
01858 <span class="stringliteral">  } // function add_term</span>
01859 <span class="stringliteral"></span>
<a name="l01883"></a><a class="code" href="classTextile.html#d10">01883</a> <span class="stringliteral">  function format_list($args) {</span>
01884 <span class="stringliteral">    $str = ($args['text'] ? $args['text'] : '');</span>
01885 <span class="stringliteral"></span>
01886 <span class="stringliteral">    $list_tags = array('*' =&gt; 'ul', '#' =&gt; 'ol');</span>
01887 <span class="stringliteral"></span>
01888 <span class="stringliteral">    $lines = preg_split('/\n/', $str);</span>
01889 <span class="stringliteral"></span>
01890 <span class="stringliteral">    unset($stack);</span>
01891 <span class="stringliteral">    $last_depth = 0;</span>
01892 <span class="stringliteral">    $item = '';</span>
01893 <span class="stringliteral">    $out = '';</span>
01894 <span class="stringliteral">    foreach ($lines as $line) {</span>
01895 <span class="stringliteral">      if (preg_match('{^((?:' . $this-&gt;clstypadre . '*|' . $this-&gt;halignre . ')*)</span>
01896 <span class="stringliteral">                       ([\#\*]+)</span>
01897 <span class="stringliteral">                       ((?:' . $this-&gt;halignre . '|' . $this-&gt;clstypadre . '*)*)</span>
01898 <span class="stringliteral">                       \ (.+)$}x', $line, $matches)) {</span>
01899 <span class="stringliteral">        if ($item != '') {</span>
01900 <span class="stringliteral">          if (preg_match('/\n/', $item)) {</span>
01901 <span class="stringliteral">            if ($this-&gt;options['_line_open']) {</span>
01902 <span class="stringliteral">              $item = preg_replace('/(&lt;li[^&gt;]*&gt;|^)/m', '$1' . $this-&gt;options['_line_open'], $item);</span>
01903 <span class="stringliteral">              $item = preg_replace('/(\n|$)/s', $this-&gt;options['_line_close'] . '$1', $item);</span>
01904 <span class="stringliteral">            } else {</span>
01905 <span class="stringliteral">              $item = preg_replace('/(\n)/s', $this-&gt;options['_line_close'] . '$1', $item);</span>
01906 <span class="stringliteral">            }</span>
01907 <span class="stringliteral">          }</span>
01908 <span class="stringliteral">          $out .= $item;</span>
01909 <span class="stringliteral">          $item = '';</span>
01910 <span class="stringliteral">        }</span>
01911 <span class="stringliteral">        $type = substr($matches[2], 0, 1);</span>
01912 <span class="stringliteral">        $depth = strlen($matches[2]);</span>
01913 <span class="stringliteral">        $blockparam = $matches[1];</span>
01914 <span class="stringliteral">        $itemparam = $matches[3];</span>
01915 <span class="stringliteral">        $line = $matches[4];</span>
01916 <span class="stringliteral">        unset ($blockclsty, $blockalign, $blockattr, $itemattr, $itemclsty,</span>
01917 <span class="stringliteral">               $itemalign);</span>
01918 <span class="stringliteral">        if (preg_match('{(' . $this-&gt;clstypadre . '+)}x', $blockparam, $matches)) {</span>
01919 <span class="stringliteral">          $blockclsty = $matches[1];</span>
01920 <span class="stringliteral">        }</span>
01921 <span class="stringliteral">        if (preg_match('{(' . $this-&gt;halignre . '+)}', $blockparam, $matches)) {</span>
01922 <span class="stringliteral">          $blockalign = $matches[1];</span>
01923 <span class="stringliteral">        }</span>
01924 <span class="stringliteral">        if (preg_match('{(' . $this-&gt;clstypadre . '+)}x', $itemparam, $matches)) {</span>
01925 <span class="stringliteral">          $itemclsty = $matches[1];</span>
01926 <span class="stringliteral">        }</span>
01927 <span class="stringliteral">        if (preg_match('{(' . $this-&gt;halignre . '+)}', $itemparam, $matches)) {</span>
01928 <span class="stringliteral">          $itemalign = $matches[1];</span>
01929 <span class="stringliteral">        }</span>
01930 <span class="stringliteral">        if ($itemclsty) { $itemattr = $this-&gt;format_classstyle($itemclsty); }</span>
01931 <span class="stringliteral">        if ($depth &gt; $last_depth) {</span>
01932 <span class="stringliteral">          for ($j = $last_depth; $j &lt; $depth; $j++) {</span>
01933 <span class="stringliteral">            $out .= "</span>\n&lt;$list_tags[$type]<span class="stringliteral">";</span>
01934 <span class="stringliteral">            $stack[] = $type;</span>
01935 <span class="stringliteral">            if ($blockclsty) {</span>
01936 <span class="stringliteral">              $blockattr = $this-&gt;format_classstyle($blockclsty);</span>
01937 <span class="stringliteral">              if ($blockattr) { $out .= ' ' . $blockattr; }</span>
01938 <span class="stringliteral">            }</span>
01939 <span class="stringliteral">            $out .= "</span>&gt;\n&lt;li<span class="stringliteral">";</span>
01940 <span class="stringliteral">            if ($itemattr) { $out .= "</span> $itemattr<span class="stringliteral">"; }</span>
01941 <span class="stringliteral">            $out .= "</span>&gt;<span class="stringliteral">";</span>
01942 <span class="stringliteral">          }</span>
01943 <span class="stringliteral">        } elseif ($depth &lt; $last_depth) {</span>
01944 <span class="stringliteral">          for ($j = $depth; $j &lt; $last_depth; $j++) {</span>
01945 <span class="stringliteral">            if ($j == $depth) { $out .= "</span>&lt;/li&gt;\n<span class="stringliteral">"; }</span>
01946 <span class="stringliteral">            $type = array_pop($stack);</span>
01947 <span class="stringliteral">            $out .= "</span>&lt;/$list_tags[$type]&gt;\n&lt;/li&gt;\n<span class="stringliteral">";</span>
01948 <span class="stringliteral">          }</span>
01949 <span class="stringliteral">          if ($depth) {</span>
01950 <span class="stringliteral">            $out .= '&lt;li';</span>
01951 <span class="stringliteral">            if ($itemattr) { $out .= "</span> $itemattr<span class="stringliteral">"; }</span>
01952 <span class="stringliteral">            $out .= '&gt;';</span>
01953 <span class="stringliteral">          }</span>
01954 <span class="stringliteral">        } else {</span>
01955 <span class="stringliteral">          $out .= "</span>&lt;/li&gt;\n&lt;li<span class="stringliteral">";</span>
01956 <span class="stringliteral">          if ($itemattr) { $out .= "</span> $itemattr<span class="stringliteral">"; }</span>
01957 <span class="stringliteral">          $out .= '&gt;';</span>
01958 <span class="stringliteral">        }</span>
01959 <span class="stringliteral">        $last_depth = $depth;</span>
01960 <span class="stringliteral">      }</span>
01961 <span class="stringliteral">      if ($item != '') { $item .= "</span>\n<span class="stringliteral">"; }</span>
01962 <span class="stringliteral">      $item .= $this-&gt;format_paragraph(array('text' =&gt; $line));</span>
01963 <span class="stringliteral">    }</span>
01964 <span class="stringliteral"></span>
01965 <span class="stringliteral">    if (preg_match('/\n/', $item, $matches)) {</span>
01966 <span class="stringliteral">      if ($this-&gt;options['_line_open']) {</span>
01967 <span class="stringliteral">        $item = preg_replace('/(&lt;li[^&gt;]*&gt;|^)/m', '$1' . $this-&gt;options['_line_open'], $item);</span>
01968 <span class="stringliteral">        $item = preg_replace('/(\n|$)/s', $this-&gt;options['_line_close'] . '$1', $item);</span>
01969 <span class="stringliteral">      } else {</span>
01970 <span class="stringliteral">        $item = preg_replace('/(\n)/s', $this-&gt;options['_line_close'] . '$1', $item);</span>
01971 <span class="stringliteral">      }</span>
01972 <span class="stringliteral">    }</span>
01973 <span class="stringliteral">    $out .= $item;</span>
01974 <span class="stringliteral"></span>
01975 <span class="stringliteral">    for ($j = 1; $j &lt;= $last_depth; $j++) {</span>
01976 <span class="stringliteral">      if ($j == 1) { $out .= '&lt;/li&gt;'; }</span>
01977 <span class="stringliteral">      $type = array_pop($stack);</span>
01978 <span class="stringliteral">      $out .= "</span>\n<span class="stringliteral">" . '&lt;/' . $list_tags[$type] . '&gt;' . "</span>\n<span class="stringliteral">";</span>
01979 <span class="stringliteral">      if ($j != $last_depth) { $out .= '&lt;/li&gt;'; }</span>
01980 <span class="stringliteral">    }</span>
01981 <span class="stringliteral"></span>
01982 <span class="stringliteral">    return $out . "</span>\n<span class="stringliteral">";</span>
01983 <span class="stringliteral">  } // function format_list</span>
01984 <span class="stringliteral"></span>
<a name="l02003"></a><a class="code" href="classTextile.html#d11">02003</a> <span class="stringliteral">  function format_block($args) {</span>
02004 <span class="stringliteral">    $str = ($args['text'] ? $args['text'] : '');</span>
02005 <span class="stringliteral">    $inline = $args['inline'];</span>
02006 <span class="stringliteral">    $pre = ($args['pre'] ? $args['pre'] : '');</span>
02007 <span class="stringliteral">    $post = ($args['post'] ? $args['post'] : '');</span>
02008 <span class="stringliteral">    $this-&gt;_strip_borders($pre, $post);</span>
02009 <span class="stringliteral">    $filters = (preg_match('/^(\|(?:(?:[a-z0-9_\-]+)\|)+)/', $str, $matches) ? $matches[1] : '');</span>
02010 <span class="stringliteral">    if ($filters) {</span>
02011 <span class="stringliteral">      $filtreg = preg_replace('/[^A-Za-z0-9]/', '\\\\$1', $filters);</span>
02012 <span class="stringliteral">      $str = preg_replace('/^' . $filtreg . '/', '', $str, 1);</span>
02013 <span class="stringliteral">      $filters = preg_replace('/^\|/', '', $filters, 1);</span>
02014 <span class="stringliteral">      $filters = preg_replace('/\|$/', '', $filter, 1);</span>
02015 <span class="stringliteral">      $filters = preg_split('/\|/', $filters);</span>
02016 <span class="stringliteral">      $str = $this-&gt;apply_filters(array('text' =&gt; $str, 'filters' =&gt; $filters));</span>
02017 <span class="stringliteral">      $count = count($filters);</span>
02018 <span class="stringliteral">      if ($str = preg_replace('!(&lt;p&gt;){' . $count . '}!se', '(++$i ? "</span>$1<span class="stringliteral">" : "</span>$1<span class="stringliteral">")', $str) &amp;&amp; $i) {</span>
02019 <span class="stringliteral">        $str = preg_replace('!(&lt;/p&gt;){' . $count . '}!s', '$1', $str);</span>
02020 <span class="stringliteral">        $str = preg_replace('!(&lt;br( /)?&gt;){' . $count . '}!s', '$1', $str);</span>
02021 <span class="stringliteral">      }</span>
02022 <span class="stringliteral">    }</span>
02023 <span class="stringliteral">    if ($inline) {</span>
02024 <span class="stringliteral">      // strip off opening para, closing para, since we're</span>
02025 <span class="stringliteral">      // operating within an inline block</span>
02026 <span class="stringliteral">      $str = preg_replace('/^\s*&lt;p[^&gt;]*&gt;/', '', $str, 1);</span>
02027 <span class="stringliteral">      $str = preg_replace('/&lt;\/p&gt;\s*$/', '', $str, 1);</span>
02028 <span class="stringliteral">    }</span>
02029 <span class="stringliteral">    return $pre . $str . $post;</span>
02030 <span class="stringliteral">  } // function format_block</span>
02031 <span class="stringliteral"></span>
<a name="l02043"></a><a class="code" href="classTextile.html#d12">02043</a> <span class="stringliteral">  function format_link($args) {</span>
02044 <span class="stringliteral">    $text = ($args['text'] ? $args['text'] : '');</span>
02045 <span class="stringliteral">    $linktext = ($args['linktext'] ? $args['linktext'] : '');</span>
02046 <span class="stringliteral">    $title = $args['title'];</span>
02047 <span class="stringliteral">    $url = $args['url'];</span>
02048 <span class="stringliteral">    $clsty = $args['clsty'];</span>
02049 <span class="stringliteral"></span>
02050 <span class="stringliteral">    if (!$url || ($url == '')) {</span>
02051 <span class="stringliteral">      return $text;</span>
02052 <span class="stringliteral">    }</span>
02053 <span class="stringliteral">    if ($this-&gt;links &amp;&amp; $this-&gt;links[$url]) {</span>
02054 <span class="stringliteral">      $title = ($title ? $title : $this-&gt;links[$url]['title']);</span>
02055 <span class="stringliteral">      $url = $this-&gt;links[$url]['url'];</span>
02056 <span class="stringliteral">    }</span>
02057 <span class="stringliteral">    $linktext = preg_replace('/ +$/', '', $linktext, 1);</span>
02058 <span class="stringliteral">    $linktext = $this-&gt;format_paragraph(array('text' =&gt; $linktext));</span>
02059 <span class="stringliteral">    $url = $this-&gt;format_url(array('linktext' =&gt; $linktext, 'url' =&gt; $url));</span>
02060 <span class="stringliteral">    $tag = "</span>&lt;a href=\<span class="stringliteral">"$url\""</span>;
02061     $attr = $this-&gt;format_classstyle($clsty);
02062     <span class="keywordflow">if</span> ($attr) { $tag .= <span class="stringliteral">" $attr"</span>; }
02063     <span class="keywordflow">if</span> ($title) {
02064       $title = preg_replace('/^\s+/', '', $title, 1);
02065       <span class="keywordflow">if</span> (strlen($title)) { $tag .= <span class="stringliteral">" title=\"$title\""</span>; }
02066     }
02067     $tag .= <span class="stringliteral">"&gt;$linktext&lt;/a&gt;"</span>;
02068     <span class="keywordflow">return</span> $tag;
02069   } <span class="comment">// function format_link</span>
02070 
<a name="l02081"></a><a class="code" href="classTextile.html#d13">02081</a>   function format_url($args) {
02082     $url = ($args['url'] ? $args['url'] : '');
02083     <span class="keywordflow">if</span> (preg_match('/^(mailto:)?([-\+\w]+@[-\w]+(\.\w[-\w]*)+)$/', $url, $matches)) {
02084       $url = 'mailto:' . $this-&gt;mail_encode($matches[2]);
02085     }
02086     <span class="keywordflow">if</span> (!preg_match('!^(/|\./|\.\./|#)!', $url)) {
02087       <span class="keywordflow">if</span> (!preg_match('!^(https?|ftp|mailto|nntp|telnet)!', $url)) { $url = <span class="stringliteral">"http://$url"</span>; }
02088     }
02089     $url = preg_replace('/&amp;(?!amp;)/', '&amp;amp;', $url);
02090     $url = preg_replace('/\ /', <span class="charliteral">'+'</span>, $url);
02091     $url = preg_replace_callback('/^((?:.+?)\?)(.+)$/', $this-&gt;_cb('$m[1] . $me-&gt;encode_url($m[2])'), $url);
02092     <span class="keywordflow">return</span> $url;
02093   } <span class="comment">// function format_url</span>
02094 
<a name="l02102"></a><a class="code" href="classTextile.html#d14">02102</a>   function format_span($args) {
02103     $text = ($args['text'] ? $args['text'] : '');
02104     $pre = ($args['pre'] ? $args['pre'] : '');
02105     $post = ($args['post'] ? $args['post'] : '');
02106     $align = $args['align'];
02107     $cite = ($args['cite'] ? $args['cite'] : '');
02108     $clsty = $args['clsty'];
02109     $this-&gt;_strip_borders($pre, $post);
02110     unset($<span class="keyword">class</span>, $style);
02111     $tag  = <span class="stringliteral">"&lt;span"</span>;
02112     $style = '';
02113     <span class="keywordflow">if</span> ($align) {
02114       <span class="keywordflow">if</span> ($self-&gt;options['css_mode']) {
02115         $alignment = $this-&gt;_halign($align);
02116         <span class="keywordflow">if</span> ($alignment) { $style .= <span class="stringliteral">";float:$alignment"</span>; }
02117         <span class="keywordflow">if</span> ($alignment) { $class .= <span class="charliteral">' '</span> . $this-&gt;options['css'][<span class="stringliteral">"class_align_$alignment"</span>]; }
02118       } <span class="keywordflow">else</span> {
02119         $alignment = ($this-&gt;_halign($align) ? $this-&gt;_halign($align) : $this-&gt;_valign($align));
02120         <span class="keywordflow">if</span> ($alignment) { $tag .= <span class="stringliteral">" align=\"$alignment\""</span>; }
02121       }
02122     }
02123     $attr = $this-&gt;format_classstyle($clsty, $<span class="keyword">class</span>, $style);
02124     <span class="keywordflow">if</span> ($attr) { $tag .= <span class="stringliteral">" $attr"</span>; }
02125     <span class="keywordflow">if</span> ($cite) {
02126       $cite = preg_replace('/^:/', '', $cite, 1);
02127       $cite = $this-&gt;format_url(array('url' =&gt; $cite));
02128       $tag .= <span class="stringliteral">" cite=\"$cite\""</span>;
02129     }
02130     <span class="keywordflow">return</span> $pre . $tag . <span class="charliteral">'&gt;'</span> . $this-&gt;format_paragraph(array('text' =&gt; $text)) . '&lt;/span&gt;' . $post;
02131   } <span class="comment">// function format_span</span>
02132 
<a name="l02186"></a><a class="code" href="classTextile.html#d15">02186</a>   function format_image($args) {
02187     $src = ($args['src'] ? $args['src'] : '');
02188     $extra = $args['extra'];
02189     $align = $args['align'];
02190     $pre = ($args['pre'] ? $args['pre'] : '');
02191     $post = ($args['post'] ? $args['post'] : '');
02192     $link = $args['url'];
02193     $clsty = $args['clsty'];
02194     $this-&gt;_strip_borders($pre, $post);
02195     <span class="keywordflow">if</span> (strlen($src) == 0) { <span class="keywordflow">return</span> $pre . '!!' . $post; }
02196     unset($tag);
02197     <span class="keywordflow">if</span> (preg_match('/^xhtml2/', $this-&gt;options['flavor'])) {
02198       unset($type); <span class="comment">// poor man's mime typing. need to extend this externally</span>
02199       <span class="keywordflow">if</span> (preg_match('/(?:\.jpeg|\.jpg)$/i', $src)) {
02200         $type = 'image/jpeg';
02201       } elseif (preg_match('/\.gif$/i', $src)) {
02202         $type = 'image/gif';
02203       } elseif (preg_match('/\.png$/i', $src)) {
02204         $type = 'image/png';
02205       } elseif (preg_match('/\.tiff$/i', $src)) {
02206         $type = 'image/tiff';
02207       }
02208       $tag = <span class="stringliteral">"&lt;object"</span>;
02209       <span class="keywordflow">if</span> ($type) { $tag .= <span class="stringliteral">" type=\"$type\""</span>; }
02210       $tag .= <span class="stringliteral">" data=\"$src\""</span>;
02211     } <span class="keywordflow">else</span> {
02212       $tag = <span class="stringliteral">"&lt;img src=\"$src\""</span>;
02213     }
02214     unset($<span class="keyword">class</span>, $style);
02215     <span class="keywordflow">if</span> ($align) {
02216       <span class="keywordflow">if</span> ($this-&gt;options['css_mode']) {
02217         $alignment = $this-&gt;_halign($align);
02218         <span class="keywordflow">if</span> ($alignment) { $style .= <span class="stringliteral">";float:$alignment"</span>; }
02219         <span class="keywordflow">if</span> ($alignment) { $class .= <span class="charliteral">' '</span> . $alignment; }
02220         $alignment = $this-&gt;_valign($align);
02221         <span class="keywordflow">if</span> ($alignment) {
02222           $imgvalign = (preg_match('/(top|bottom)/', $alignment) ? 'text-' . $alignment : $alignment);
02223           <span class="keywordflow">if</span> ($imgvalign) { $style .= <span class="stringliteral">";vertical-align:$imgvalign"</span>; }
02224           <span class="keywordflow">if</span> ($alignment) { $class .= <span class="charliteral">' '</span> . $this-&gt;options['css'][<span class="stringliteral">"class_align_$alignment"</span>]; }
02225         }
02226       } <span class="keywordflow">else</span> {
02227         $alignment = ($this-&gt;_halign($align) ? $this-&gt;_halign($align) : $this-&gt;_valign($align));
02228         <span class="keywordflow">if</span> ($alignment) { $tag .= <span class="stringliteral">" align=\"$alignment\""</span>; }
02229       }
02230     }
02231     unset($pctw, $pcth, $w, $h, $alt);
02232     <span class="keywordflow">if</span> ($extra) {
02233       $alt = (preg_match('/\(([^\)]+)\)/', $extra, $matches) ? $matches[1] : '');
02234       $extra = preg_replace('/\([^\)]+\)/', '', $extra, 1);
02235       $pct = (preg_match('/(^|\s)(\d+)%(\s|$)/', $extra, $matches) ? $matches[2] : '');
02236       <span class="keywordflow">if</span> (!$pct) {
02237         list($pctw, $pcth) = (preg_match('/(^|\s)(\d+)%x(\d+)%(\s|$)/', $extra, $matches) ? array($matches[2], $matches[3]) : NULL);
02238       } <span class="keywordflow">else</span> {
02239         $pctw = $pcth = $pct;
02240       }
02241       <span class="keywordflow">if</span> (!$pctw &amp;&amp; !$pcth) {
02242         list($w,$h) = (preg_match('/(^|\s)(\d+|\*)x(\d+|\*)(\s|$)/', $extra, $matches) ? array($matches[2], $matches[3]) : NULL);
02243         <span class="keywordflow">if</span> ($w == <span class="charliteral">'*'</span>) { $w = ''; }
02244         <span class="keywordflow">if</span> ($h == <span class="charliteral">'*'</span>) { $h = ''; }
02245         <span class="keywordflow">if</span> (!$w) {
02246           $w = (preg_match('/(^|[,\s])(\d+)w([\s,]|$)/', $extra, $matches) ? $matches[2] : '');
02247         }
02248         <span class="keywordflow">if</span> (!$h) {
02249           $h = (preg_match('/(^|[,\s])(\d+)h([\s,]|$)/', $extra, $matches) ? $matches[2] : '');
02250         }
02251       }
02252     }
02253     $alt = ($alt ? $alt : '');
02254     <span class="keywordflow">if</span> (!preg_match('/^xhtml2/', $this-&gt;options['flavor'])) {
02255       $tag .= ' alt=<span class="stringliteral">"' . $this-&gt;encode_html_basic($alt) . '"</span>';
02256     }
02257     <span class="keywordflow">if</span> ($w &amp;&amp; $h) {
02258       <span class="keywordflow">if</span> (!preg_match('/^xhtml2/', $this-&gt;options['flavor'])) {
02259         $tag .= <span class="stringliteral">" height=\"$h\" width=\"$w\""</span>;
02260       } <span class="keywordflow">else</span> {
02261         $style .= <span class="stringliteral">";height:${h}px;width:${w}px"</span>;
02262       }
02263     } <span class="keywordflow">else</span> {
02264       list($image_w, $image_h) = $this-&gt;image_size($src);
02265       <span class="keywordflow">if</span> (($image_w &amp;&amp; $image_h) &amp;&amp; ($w || $h)) {
02266         <span class="comment">// image size determined, but only width or height specified</span>
02267         <span class="keywordflow">if</span> ($w &amp;&amp; !$h) {
02268           <span class="comment">// width defined, scale down height proportionately</span>
02269           $h = intval($image_h * ($w / $image_w));
02270         } elseif ($h &amp;&amp; !$w) {
02271           $w = intval($image_w * ($h / $image_h));
02272         }
02273       } <span class="keywordflow">else</span> {
02274         $w = $image_w;
02275         $h = $image_h;
02276       }
02277       <span class="keywordflow">if</span> ($w &amp;&amp; $h) {
02278         <span class="keywordflow">if</span> ($pctw || $pcth) {
02279           $w = intval($w * $pctw / 100);
02280           $h = intval($h * $pcth / 100);
02281         }
02282         <span class="keywordflow">if</span> (!preg_match('/^xhtml2/', $this-&gt;options['flavor'])) {
02283           $tag .= <span class="stringliteral">" height=\"$h\" width=\"$w\""</span>;
02284         } <span class="keywordflow">else</span> {
02285           $style .= <span class="stringliteral">";height:{$h}px;width:{$w}px"</span>;
02286         }
02287       }
02288     }
02289     $attr = $this-&gt;format_classstyle($clsty, $<span class="keyword">class</span>, $style);
02290     <span class="keywordflow">if</span> ($attr) { $tag .= <span class="stringliteral">" $attr"</span>; }
02291     <span class="keywordflow">if</span> (preg_match('/^xhtml2/', $this-&gt;options['flavor'])) {
02292       $tag .= '&gt;&lt;p&gt;' . $this-&gt;encode_html_basic($alt) . '&lt;/p&gt;&lt;/object&gt;';
02293     } elseif (preg_match('/^xhtml/', $this-&gt;options['flavor'])) {
02294       $tag .= ' /&gt;';
02295     } <span class="keywordflow">else</span> {
02296       $tag .= <span class="charliteral">'&gt;'</span>;
02297     }
02298     <span class="keywordflow">if</span> ($link) {
02299       $link = preg_replace('/^:/', '', $link, 1);
02300       $link = $this-&gt;format_url(array('url' =&gt; $link));
02301       $tag = '&lt;a href=<span class="stringliteral">"' . $link . '"</span>&gt;' . $tag . '&lt;/a&gt;';
02302     }
02303     <span class="keywordflow">return</span> $pre . $tag . $post;
02304   } <span class="comment">// function format_image</span>
02305 
<a name="l02317"></a><a class="code" href="classTextile.html#d16">02317</a>   function format_table($args) {
02318     $str = ($args['text'] ? $args['text'] : '');
02319 
02320     $lines = preg_split('/\n/', $str);
02321     unset($rows);
02322     $line_count = count($lines);
02323     <span class="keywordflow">for</span> ($i = 0; $i &lt; $line_count; $i++) {
02324       <span class="keywordflow">if</span> (!preg_match('/\|\s*$/', $lines[$i])) {
02325         <span class="keywordflow">if</span> ($i + 1 &lt; $line_count) {
02326           <span class="keywordflow">if</span> ($i + 1 &lt;= count($lines) - 1) { $lines[$i + 1] = $lines[$i] . <span class="stringliteral">"\n"</span> . $lines[$i + 1]; }
02327         } <span class="keywordflow">else</span> {
02328           $rows[] = $lines[$i];
02329         }
02330       } <span class="keywordflow">else</span> {
02331         $rows[] = $lines[$i];
02332       }
02333     }
02334     unset($tid, $tpadl, $tpadr, $tlang);
02335     $tclass = '';
02336     $tstyle = '';
02337     $talign = '';
02338     <span class="keywordflow">if</span> (preg_match('/^table[^\.]/', $rows[0])) {
02339       $row = $rows[0];
02340       $row = preg_replace('/^table/', '', $row, 1);
02341       $params = 1;
02342       <span class="comment">// process row parameters until none are left</span>
02343       <span class="keywordflow">while</span> ($params) {
02344         <span class="keywordflow">if</span> (preg_match('{^(' . $this-&gt;tblalignre . ')}', $row, $matches)) {
02345           <span class="comment">// found row alignment</span>
02346           $talign .= $matches[1];
02347           <span class="keywordflow">if</span> ($matches[1]) { $row = substr($row, strlen($matches[1])); }
02348           <span class="keywordflow">if</span> ($matches[1]) { <span class="keywordflow">continue</span>; }
02349         }
02350         <span class="keywordflow">if</span> (preg_match('{^(' . $this-&gt;clstypadre . ')}x', $row, $matches)) {
02351           <span class="comment">// found a class/id/style/padding indicator</span>
02352           $clsty = $matches[1];
02353           <span class="keywordflow">if</span> ($clsty) { $row = substr($row, strlen($clsty)); }
02354           <span class="keywordflow">if</span> (preg_match('/{([^}]+)}/', $clsty, $matches)) {
02355             $tstyle = $matches[1];
02356             $clsty = preg_replace('/{([^}]+)}/', '', $clsty, 1);
02357             <span class="keywordflow">if</span> ($tstyle) { <span class="keywordflow">continue</span>; }
02358           }
02359           <span class="keywordflow">if</span> (preg_match('/\(([A-Za-z0-9_\- ]+?)(?:#(.+?))?\)/', $clsty, $matches) ||
02360               preg_match('/\(([A-Za-z0-9_\- ]+?)?(?:#(.+?))\)/', $clsty, $matches)) {
02361             <span class="keywordflow">if</span> ($matches[1] || $matches[2]) {
02362               $tclass = $matches[1];
02363               $tid = $matches[2];
02364               <span class="keywordflow">continue</span>;
02365             }
02366           }
02367           <span class="keywordflow">if</span> (preg_match('/(\(+)/', $clsty, $matches)) { $tpadl = strlen($matches[1]); }
02368           <span class="keywordflow">if</span> (preg_match('/(\)+)/', $clsty, $matches)) { $tpadr = strlen($matches[1]); }
02369           <span class="keywordflow">if</span> (preg_match('/\[(.+?)\]/', $clsty, $matches)) { $tlang = $matches[1]; }
02370           <span class="keywordflow">if</span> ($clsty) { <span class="keywordflow">continue</span>; }
02371         }
02372         $params = 0;
02373       }
02374       $row = preg_replace('/\.\s+/', '', $row, 1);
02375       $rows[0] = $row;
02376     }
02377     $out = '';
02378     $cols = preg_split('/\|/', $rows[0] . <span class="charliteral">' '</span>);
02379     unset($colaligns, $rowspans);
02380     foreach ($rows as $row) {
02381       $cols = preg_split('/\|/', $row . <span class="charliteral">' '</span>);
02382       $colcount = count($cols) - 1;
02383       array_pop($cols);
02384       $colspan = 0;
02385       $row_out = '';
02386       unset($rowclass, $rowid, $rowalign, $rowstyle, $rowheader);
02387       <span class="keywordflow">if</span> (!$cols[0]) { $cols[0] = ''; }
02388       <span class="keywordflow">if</span> (preg_match('/_/', $cols[0])) {
02389         $cols[0] = preg_replace('/_/', '', $cols[0]);
02390         $rowheader = 1;
02391       }
02392       <span class="keywordflow">if</span> (preg_match('/{([^}]+)}/', $cols[0], $matches)) {
02393         $rowstyle = $matches[1];
02394         $cols[0] = preg_replace('/{[^}]+}/', '', $cols[0]);
02395       }
02396       <span class="keywordflow">if</span> (preg_match('/\(([^\#]+?)?(#(.+))?\)/', $cols[0], $matches)) {
02397         $rowclass = $matches[1];
02398         $rowid = $matches[3];
02399         $cols[0] = preg_replace('/\([^\)]+\)/', '', $cols[0]);
02400       }
02401       <span class="keywordflow">if</span> (preg_match('{(' . $this-&gt;alignre . ')}', $cols[0], $matches)) { $rowalign = $matches[1]; }
02402       <span class="keywordflow">for</span> ($c = $colcount - 1; $c &gt; 0; $c--) {
02403         <span class="keywordflow">if</span> ($rowspans[$c]) {
02404           $rowspans[$c]--;
02405           <span class="keywordflow">if</span> ($rowspans[$c] &gt; 1) { <span class="keywordflow">continue</span>; }
02406         }
02407         unset($colclass, $colid, $header, $colparams, $colpadl, $colpadr, $collang);
02408         $colstyle = '';
02409         $colalign = $colaligns[$c];
02410         $col = array_pop($cols);
02411         $col = ($col ? $col : '');
02412         $attrs = '';
02413         <span class="keywordflow">if</span> (preg_match('{^(((_|[/\\\\]\d+|' . $this-&gt;alignre . <span class="charliteral">'|'</span> . $this-&gt;clstypadre . ')+)\.\ )}x', $col, $matches)) {
02414           $colparams = $matches[2];
02415           $col = substr($col, strlen($matches[1]));
02416           $params = 1;
02417           <span class="comment">// keep processing column parameters until there</span>
02418           <span class="comment">// are none left...</span>
02419           <span class="keywordflow">while</span> ($params) {
02420             <span class="keywordflow">if</span> (preg_match('{^(_|' . $this-&gt;alignre . ')(.*)$}', $colparams, $matches)) {
02421               <span class="comment">// found alignment or heading indicator</span>
02422               $attrs .= $matches[1];
02423               <span class="keywordflow">if</span> ($matches[1]) { $colparams = $matches[2]; }
02424               <span class="keywordflow">if</span> ($matches[1]) { <span class="keywordflow">continue</span>; }
02425             }
02426             <span class="keywordflow">if</span> (preg_match('{^(' . $this-&gt;clstypadre . ')(.*)$}x', $colparams, $matches)) {
02427               <span class="comment">// found a class/id/style/padding marker</span>
02428               $clsty = $matches[1];
02429               <span class="keywordflow">if</span> ($clsty) { $colparams = $matches[2]; }
02430               <span class="keywordflow">if</span> (preg_match('/{([^}]+)}/', $clsty, $matches)) {
02431                 $colstyle = $matches[1];
02432                 $clsty = preg_replace('/{([^}]+)}/', '', $clsty, 1);
02433               }
02434               <span class="keywordflow">if</span> (preg_match('/\(([A-Za-z0-9_\- ]+?)(?:#(.+?))?\)/', $clsty, $matches) ||
02435                   preg_match('/\(([A-Za-z0-9_\- ]+?)?(?:#(.+?))\)/', $clsty, $matches)) {
02436                 <span class="keywordflow">if</span> ($matches[1] || $matches[2]) {
02437                   $colclass = $matches[1];
02438                   $colid = $matches[2];
02439                   <span class="keywordflow">if</span> ($colclass) {
02440                     $clsty = preg_replace('/\([A-Za-z0-9_\- ]+?(#.*?)?\)/', '', $clsty);
02441                   } elseif ($colid) {
02442                     $clsty = preg_replace('/\(#.+?\)/', '', $clsty);
02443                   }
02444                 }
02445               }
02446               <span class="keywordflow">if</span> (preg_match('/(\(+)/', $clsty, $matches)) {
02447                 $colpadl = strlen($matches[1]);
02448                 $clsty = preg_replace('/\(+/', '', $clsty, 1);
02449               }
02450               <span class="keywordflow">if</span> (preg_match('/(\)+)/', $clsty, $matches)) {
02451                 $colpadr = strlen($matches[1]);
02452                 $clsty = preg_replace('/\)+/', '', $clsty, 1);
02453               }
02454               <span class="keywordflow">if</span> (preg_match('/\[(.+?)\]/', $clsty, $matches)) {
02455                 $collang = $matches[1];
02456                 $clsty = preg_replace('/\[.+?\]/', '', $clsty, 1);
02457               }
02458               <span class="keywordflow">if</span> ($clsty) { <span class="keywordflow">continue</span>; }
02459             }
02460             <span class="keywordflow">if</span> (preg_match('/^\\\\(\d+)/', $colparams, $matches)) {
02461               $colspan = $matches[1];
02462               $colparams = substr($colparams, strlen($matches[1]) + 1);
02463               <span class="keywordflow">if</span> ($matches[1]) { <span class="keywordflow">continue</span>; }
02464             }
02465             <span class="keywordflow">if</span> (preg_match('/\/(\d+)/', $colparams, $matches)) {
02466               <span class="keywordflow">if</span> ($matches[1]) { $rowspans[$c] = $matches[1]; }
02467               $colparams = substr($colparams, strlen($matches[1]) + 1);
02468               <span class="keywordflow">if</span> ($matches[1]) { <span class="keywordflow">continue</span>; }
02469             }
02470             $params = 0;
02471           }
02472         }
02473         <span class="keywordflow">if</span> (strlen($attrs)) {
02474           <span class="keywordflow">if</span> (preg_match('/_/', $attrs)) { $header = 1; }
02475           <span class="keywordflow">if</span> (preg_match('{(' . $this-&gt;alignre . ')}', $attrs, $matches) &amp;&amp; strlen($matches[1])) { $colalign = ''; }
02476           <span class="comment">// determine column alignment</span>
02477           <span class="keywordflow">if</span> (preg_match('/&lt;&gt;/', $attrs)) {
02478             $colalign .= '&lt;&gt;';
02479           } elseif (preg_match('/&lt;/', $attrs)) {
02480             $colalign .= <span class="charliteral">'&lt;'</span>;
02481           } elseif (preg_match('/=/', $attrs)) {
02482             $colalign = <span class="charliteral">'='</span>;
02483           } elseif (preg_match('/&gt;/', $attrs)) {
02484             $colalign = <span class="charliteral">'&gt;'</span>;
02485           }
02486           <span class="keywordflow">if</span> (preg_match('/\^/', $attrs)) {
02487             $colalign .= <span class="charliteral">'^'</span>;
02488           } elseif (preg_match('/~/', $attrs)) {
02489             $colalign .= <span class="charliteral">'~'</span>;
02490           } elseif (preg_match('/-/', $attrs)) {
02491             $colalign .= <span class="charliteral">'-'</span>;
02492           }
02493         }
02494         <span class="keywordflow">if</span> ($rowheader) { $header = 1; }
02495         <span class="keywordflow">if</span> ($header) { $colaligns[$c] = $colalign; }
02496         $col = preg_replace('/^ +/', '', $col, 1); $col = preg_replace('/ +$/', '', $col, 1);
02497         <span class="keywordflow">if</span> (strlen($col)) {
02498           <span class="comment">// create one cell tag</span>
02499           $rowspan = $rowspans[$c] || 0;
02500           $col_out = <span class="charliteral">'&lt;'</span> . ($header ? 'th' : 'td');
02501           <span class="keywordflow">if</span> ($colalign) {
02502             <span class="comment">// horizontal, vertical alignment</span>
02503             $halign = $this-&gt;_halign($colalign);
02504             <span class="keywordflow">if</span> ($halign) { $col_out .= <span class="stringliteral">" align=\"$halign\""</span>; }
02505             $valign = $this-&gt;_valign($colalign);
02506             <span class="keywordflow">if</span> ($valign) { $col_out .= <span class="stringliteral">" valign=\"$valign\""</span>; }
02507           }
02508           <span class="comment">// apply css attributes, row, column spans</span>
02509           <span class="keywordflow">if</span> ($colpadl) { $colstyle .= <span class="stringliteral">";padding-left:${colpadl}em"</span>; }
02510           <span class="keywordflow">if</span> ($colpadr) { $colstyle .= <span class="stringliteral">";padding-right:${colpadr}em"</span>; }
02511           <span class="keywordflow">if</span> ($colclass) { $col_out .= <span class="stringliteral">" class=\"$colclass\""</span>; }
02512           <span class="keywordflow">if</span> ($colid) { $col_out .= <span class="stringliteral">" id=\"$colid\""</span>; }
02513           <span class="keywordflow">if</span> ($colstyle) { $colstyle = preg_replace('/^;/', '', $colstyle, 1); }
02514           <span class="keywordflow">if</span> ($colstyle) { $col_out .= <span class="stringliteral">" style=\"$colstyle\""</span>; }
02515           <span class="keywordflow">if</span> ($collang) { $col_out .= <span class="stringliteral">" lang=\"$collang\""</span>; }
02516           <span class="keywordflow">if</span> ($colspan &gt; 1) { $col_out .= <span class="stringliteral">" colspan=\"$colspan\""</span>; }
02517           <span class="keywordflow">if</span> (($rospan || 0) &gt; 1) { $col_out .= <span class="stringliteral">" rowspan=\"$rowspan\""</span>; }
02518           $col_out .= <span class="charliteral">'&gt;'</span>;
02519           <span class="comment">// if the content of this cell has newlines OR matches</span>
02520           <span class="comment">// our paragraph block signature, process it as a full-blown</span>
02521           <span class="comment">// textile document</span>
02522           <span class="keywordflow">if</span> (preg_match('/\n\n/', $col) ||
02523               preg_match('{^(?:' . $this-&gt;halignre . <span class="charliteral">'|'</span> . $this-&gt;clstypadre . '*)*
02524                             [\*\#]
02525                             (?:' . $this-&gt;clstypadre . '*|' . $this-&gt;halignre . ')*\ }x', $col)) {
02526             $col_out .= $this-&gt;process($col);
02527           } <span class="keywordflow">else</span> {
02528             $col_out .= $this-&gt;format_paragraph(array('text' =&gt; $col));
02529           }
02530           $col_out .= '&lt;/' . ($header ? 'th' : 'td') . <span class="charliteral">'&gt;'</span>;
02531           $row_out = $col_out . $row_out;
02532           <span class="keywordflow">if</span> ($colspan) { $colspan = 0; }
02533         } <span class="keywordflow">else</span> {
02534           <span class="keywordflow">if</span> ($colspan == 0) { $colspan = 1; }
02535           $colspan++;
02536         }
02537       }
02538       <span class="keywordflow">if</span> ($colspan &gt; 1) {
02539         <span class="comment">// handle the spanned column if we came up short</span>
02540         $colspan--;
02541         $row_out = <span class="stringliteral">"&lt;td"</span>
02542                  . ($colspan &gt; 1 ? <span class="stringliteral">" colspan=\"$colspan\""</span> : '')
02543                  . <span class="stringliteral">"&gt;&lt;/td&gt;$row_out"</span>;
02544       }
02545 
02546       <span class="comment">// build one table row</span>
02547       $out .= <span class="stringliteral">"&lt;tr"</span>;
02548       <span class="keywordflow">if</span> ($rowalign) {
02549         $valign = $this-&gt;_valign($rowalign);
02550         <span class="keywordflow">if</span> ($valign) { $out .= <span class="stringliteral">" valign=\"$valign\""</span>; }
02551       }
02552       <span class="keywordflow">if</span> ($rowclass) { $out .= <span class="stringliteral">" class=\"$rowclass\""</span>; }
02553       <span class="keywordflow">if</span> ($rowid) { $out .= <span class="stringliteral">" id=\"$rowid\""</span>; }
02554       <span class="keywordflow">if</span> ($rowstyle) { $out .= <span class="stringliteral">" style=\"$rowstyle\""</span>; }
02555       $out .= <span class="stringliteral">"&gt;$row_out&lt;/tr&gt;"</span>;
02556     }
02557 
02558     <span class="comment">// now, form the table tag itself</span>
02559     $table = '';
02560     $table .= <span class="stringliteral">"&lt;table"</span>;
02561     <span class="keywordflow">if</span> ($talign) {
02562       <span class="keywordflow">if</span> ($this-&gt;options['css_mode']) {
02563         <span class="comment">// horizontal alignment</span>
02564         $alignment = $this-&gt;_halign($talign);
02565         <span class="keywordflow">if</span> ($talign == <span class="charliteral">'='</span>) {
02566           $tstyle .= ';margin-left:<span class="keyword">auto</span>;margin-right:<span class="keyword">auto</span>';
02567         } <span class="keywordflow">else</span> {
02568           <span class="keywordflow">if</span> ($alignment) { $tstyle .= ';<span class="keywordtype">float</span>:' . $alignment; }
02569         }
02570         <span class="keywordflow">if</span> ($alignment) { $tclass .= <span class="charliteral">' '</span> . $alignment; }
02571       } <span class="keywordflow">else</span> {
02572         $alignment = $this-&gt;_halign($talign);
02573         <span class="keywordflow">if</span> ($alignment) { $table .= <span class="stringliteral">" align=\"$alignment\""</span>; }
02574       }
02575     }
02576     <span class="keywordflow">if</span> ($tpadl) { $tstyle .= <span class="stringliteral">";padding-left:${tpadl}em"</span>; }
02577     <span class="keywordflow">if</span> ($tpadr) { $tstyle .= <span class="stringliteral">";padding-right:${tpadr}em"</span>; }
02578     <span class="keywordflow">if</span> ($tclass) { $tclass = preg_replace('/^ /', '', $tclass, 1); }
02579     <span class="keywordflow">if</span> ($tclass) { $table .= <span class="stringliteral">" class=\"$tclass\""</span>; }
02580     <span class="keywordflow">if</span> ($tid) { $table .= <span class="stringliteral">" id=\"$tid\""</span>; }
02581     <span class="keywordflow">if</span> ($tstyle) { $tstyle = preg_replace('/^;/', '', $tstyle, 1); }
02582     <span class="keywordflow">if</span> ($tstyle) { $table .= <span class="stringliteral">" style=\"$tstyle\""</span>; }
02583     <span class="keywordflow">if</span> ($tlang) { $table .= <span class="stringliteral">" lang=\"$tlang\""</span>; }
02584     <span class="keywordflow">if</span> ($tclass || $tid || $tstyle) { $table .= <span class="stringliteral">" cellspacing=\"0\""</span>; }
02585     $table .= <span class="stringliteral">"&gt;$out&lt;/table&gt;"</span>;
02586 
02587     <span class="keywordflow">if</span> (preg_match('|&lt;tr&gt;&lt;/tr&gt;|', $table)) {
02588       <span class="comment">// exception -- something isn't right so return fail case</span>
02589       <span class="keywordflow">return</span> NULL;
02590     }
02591 
02592     <span class="keywordflow">return</span> $table;
02593   } <span class="comment">// function format_table</span>
02594 
<a name="l02617"></a><a class="code" href="classTextile.html#d17">02617</a>   function apply_filters($args) {
02618     $text = $args['text'];
02619     <span class="keywordflow">if</span> (!$text) { <span class="keywordflow">return</span> ''; }
02620     $list = $args['filters'];
02621     $filters = $this-&gt;options['filters'];
02622     <span class="keywordflow">if</span> (!is_array($filters)) { <span class="keywordflow">return</span> $text; }
02623 
02624     $param = $this-&gt;filter_param();
02625     foreach ($list as $filter) {
02626       <span class="keywordflow">if</span> (!$filters[$filter]) { <span class="keywordflow">continue</span>; }
02627       <span class="keywordflow">if</span> (is_string($filters[$filter])) {
02628         $text = (($f = create_function('$text, $param', $filters[$filter])) ? $f($text, $param) : $text);
02629       }
02630     }
02631     <span class="keywordflow">return</span> $text;
02632   } <span class="comment">// function apply_filters</span>
02633 
02634   <span class="comment">// minor utility / formatting routines</span>
02635 
<a name="l02636"></a><a class="code" href="classTextile.html#o0">02636</a>   var $Have_Entities = 1;
02637 
<a name="l02654"></a><a class="code" href="classTextile.html#d18">02654</a>   function encode_html($html, $can_double_encode = FALSE) {
02655     <span class="keywordflow">if</span> (!$html) { <span class="keywordflow">return</span> ''; }
02656     <span class="keywordflow">if</span> ($this-&gt;Have_Entities &amp;&amp; $this-&gt;options['char_encoding']) {
02657       $html = htmlentities($html);
02658     } <span class="keywordflow">else</span> {
02659       $html = $this-&gt;encode_html_basic($html, $can_double_encode);
02660     }
02661     <span class="keywordflow">return</span> $html;
02662   } <span class="comment">// function encode_html</span>
02663 
<a name="l02674"></a><a class="code" href="classTextile.html#d19">02674</a>   function decode_html($html) {
02675     $html = preg_replace('!&amp;quot;!', <span class="charliteral">'"'</span>, $html);
02676     $html = preg_replace('!&amp;amp;!', <span class="charliteral">'&amp;'</span>, $html);
02677     $html = preg_replace('!&amp;lt;!', <span class="charliteral">'&lt;'</span>, $html);
02678     $html = preg_replace('!&amp;gt;!', <span class="charliteral">'&gt;'</span>, $html);
02679     <span class="keywordflow">return</span> $html;
02680   } <span class="comment">// function decode_html</span>
02681 
<a name="l02698"></a><a class="code" href="classTextile.html#d20">02698</a>   function encode_html_basic($html, $can_double_encode = FALSE) {
02699     <span class="keywordflow">if</span> (!$html) { <span class="keywordflow">return</span> ''; }
02700     <span class="keywordflow">if</span> (!preg_match('/[^\w\s]/', $html)) { <span class="keywordflow">return</span> $html; }
02701     <span class="keywordflow">if</span> ($can_double_encode) {
02702       $html = preg_replace('!&amp;!', '&amp;amp;', $html);
02703     } <span class="keywordflow">else</span> {
02704       <span class="comment">// Encode any &amp; not followed by something that looks like</span>
02705       <span class="comment">// an entity, numeric or otherwise.</span>
02706       $html = preg_replace('/&amp;(?!#?[xX]?(?:[0-9a-fA-F]+|\w{1,8});)/', '&amp;amp;', $html);
02707     }
02708     $html = preg_replace('!<span class="stringliteral">"!', '&amp;quot;', $html);</span>
02709 <span class="stringliteral">    $html = preg_replace('!&lt;!', '&amp;lt;', $html);</span>
02710 <span class="stringliteral">    $html = preg_replace('!&gt;!', '&amp;gt;', $html);</span>
02711 <span class="stringliteral">    return $html;</span>
02712 <span class="stringliteral">  } // function encode_html_basic</span>
02713 <span class="stringliteral"></span>
<a name="l02729"></a><a class="code" href="classTextile.html#d21">02729</a> <span class="stringliteral">  function image_size($file) {</span>
02730 <span class="stringliteral">    $Have_ImageSize = function_exists('getimagesize');</span>
02731 <span class="stringliteral"></span>
02732 <span class="stringliteral">    if ($Have_ImageSize) {</span>
02733 <span class="stringliteral">      if (file_exists($file)) {</span>
02734 <span class="stringliteral">        return @getimagesize($file);</span>
02735 <span class="stringliteral">      } else {</span>
02736 <span class="stringliteral">        if ($docroot = ($this-&gt;docroot() ? $this-&gt;docroot() : $_SERVER['DOCUMENT_ROOT'])) {</span>
02737 <span class="stringliteral">          $fullpath = $docroot . preg_replace('|^/*(.*)$|', '/$1', $file);</span>
02738 <span class="stringliteral">          if (file_exists($fullpath)) {</span>
02739 <span class="stringliteral">            return @getimagesize($fullpath);</span>
02740 <span class="stringliteral">          }</span>
02741 <span class="stringliteral">        }</span>
02742 <span class="stringliteral">      }</span>
02743 <span class="stringliteral">    }</span>
02744 <span class="stringliteral">    return @getimagesize($file);</span>
02745 <span class="stringliteral">  } // function image_size</span>
02746 <span class="stringliteral"></span>
<a name="l02757"></a><a class="code" href="classTextile.html#d22">02757</a> <span class="stringliteral">  function encode_url($str) {</span>
02758 <span class="stringliteral">    $str = preg_replace_callback('!([^A-Za-z0-9_\.\-\+\&amp;=%;])!x',</span>
02759 <span class="stringliteral">                            $this-&gt;_cb('ord($m[1]) &gt; 255 ? \'%u\' . sprintf("</span>%04X<span class="stringliteral">", ord($m[1]))</span>
02760 <span class="stringliteral">                                                       : \'%\'  . sprintf("</span>%02X<span class="stringliteral">", ord($m[1]))'), $str);</span>
02761 <span class="stringliteral">    return $str;</span>
02762 <span class="stringliteral">  } // function encode_url</span>
02763 <span class="stringliteral"></span>
<a name="l02773"></a><a class="code" href="classTextile.html#d23">02773</a> <span class="stringliteral">  function mail_encode($addr) {</span>
02774 <span class="stringliteral">    // granted, this is simple, but it gives off warm fuzzies</span>
02775 <span class="stringliteral">    $addr = preg_replace_callback('!([^\$])!x',</span>
02776 <span class="stringliteral">                             $this-&gt;_cb('ord($m[1]) &gt; 255 ? \'%u\' . sprintf("</span>%04X<span class="stringliteral">", ord($m[1]))</span>
02777 <span class="stringliteral">                                                        : \'%\'  . sprintf("</span>%02X<span class="stringliteral">", ord($m[1]))'), $addr);</span>
02778 <span class="stringliteral">    return $addr;</span>
02779 <span class="stringliteral">  } // function mail_encode</span>
02780 <span class="stringliteral"></span>
<a name="l02790"></a><a class="code" href="classTextile.html#d24">02790</a> <span class="stringliteral">  function process_quotes($str) {</span>
02791 <span class="stringliteral">    // stub routine for now. subclass and implement.</span>
02792 <span class="stringliteral">    return $str;</span>
02793 <span class="stringliteral">  } // function process_quotes</span>
02794 <span class="stringliteral"></span>
02795 <span class="stringliteral">  // a default set of macros for the {...} macro syntax</span>
02796 <span class="stringliteral">  // just a handy way to write a lot of the international characters</span>
02797 <span class="stringliteral">  // and some commonly used symbols</span>
02798 <span class="stringliteral"></span>
<a name="l02807"></a><a class="code" href="classTextile.html#d25">02807</a> <span class="stringliteral">  function default_macros() {</span>
02808 <span class="stringliteral">    // &lt;, &gt;, "</span> must be html entities in the macro text since
02809     <span class="comment">// those values are escaped by the time they are processed</span>
02810     <span class="comment">// for macros.</span>
02811     <span class="keywordflow">return</span> array(
02812       'c|' =&gt; '&amp;#162;', <span class="comment">// CENT SIGN</span>
02813       '|c' =&gt; '&amp;#162;', <span class="comment">// CENT SIGN</span>
02814       'L-' =&gt; '&amp;#163;', <span class="comment">// POUND SIGN</span>
02815       '-L' =&gt; '&amp;#163;', <span class="comment">// POUND SIGN</span>
02816       'Y=' =&gt; '&amp;#165;', <span class="comment">// YEN SIGN</span>
02817       '=Y' =&gt; '&amp;#165;', <span class="comment">// YEN SIGN</span>
02818       '(c)' =&gt; '&amp;#169;', <span class="comment">// COPYRIGHT SIGN</span>
02819       '&amp;lt;&amp;lt;' =&gt; '&amp;#171;', <span class="comment">// LEFT-POINTING DOUBLE ANGLE QUOTATION</span>
02820       '(r)' =&gt; '&amp;#174;', <span class="comment">// REGISTERED SIGN</span>
02821       '+_' =&gt; '&amp;#177;', <span class="comment">// PLUS-MINUS SIGN</span>
02822       '_+' =&gt; '&amp;#177;', <span class="comment">// PLUS-MINUS SIGN</span>
02823       '&amp;gt;&amp;gt;' =&gt; '&amp;#187;', <span class="comment">// RIGHT-POINTING DOUBLE ANGLE QUOTATION</span>
02824       '1/4' =&gt; '&amp;#188;', <span class="comment">// VULGAR FRACTION ONE QUARTER</span>
02825       '1/2' =&gt; '&amp;#189;', <span class="comment">// VULGAR FRACTION ONE HALF</span>
02826       '3/4' =&gt; '&amp;#190;', <span class="comment">// VULGAR FRACTION THREE QUARTERS</span>
02827       'A`' =&gt; '&amp;#192;', <span class="comment">// LATIN CAPITAL LETTER A WITH GRAVE</span>
02828       '`A' =&gt; '&amp;#192;', <span class="comment">// LATIN CAPITAL LETTER A WITH GRAVE</span>
02829       'A\'' =&gt; '&amp;#193;', <span class="comment">// LATIN CAPITAL LETTER A WITH ACUTE</span>
02830       <span class="charliteral">'\'</span>A' =&gt; '&amp;#193;', <span class="comment">// LATIN CAPITAL LETTER A WITH ACUTE</span>
02831       'A^' =&gt; '&amp;#194;', <span class="comment">// LATIN CAPITAL LETTER A WITH CIRCUMFLEX</span>
02832       '^A' =&gt; '&amp;#194;', <span class="comment">// LATIN CAPITAL LETTER A WITH CIRCUMFLEX</span>
02833       'A~' =&gt; '&amp;#195;', <span class="comment">// LATIN CAPITAL LETTER A WITH TILDE</span>
02834       '~A' =&gt; '&amp;#195;', <span class="comment">// LATIN CAPITAL LETTER A WITH TILDE</span>
02835       'A<span class="stringliteral">"' =&gt; '&amp;#196;', // LATIN CAPITAL LETTER A WITH DIAERESIS</span>
02836 <span class="stringliteral">      '"</span>A' =&gt; '&amp;#196;', <span class="comment">// LATIN CAPITAL LETTER A WITH DIAERESIS</span>
02837       'Ao' =&gt; '&amp;#197;', <span class="comment">// LATIN CAPITAL LETTER A WITH RING ABOVE</span>
02838       'oA' =&gt; '&amp;#197;', <span class="comment">// LATIN CAPITAL LETTER A WITH RING ABOVE</span>
02839       'AE' =&gt; '&amp;#198;', <span class="comment">// LATIN CAPITAL LETTER AE</span>
02840       'C,' =&gt; '&amp;#199;', <span class="comment">// LATIN CAPITAL LETTER C WITH CEDILLA</span>
02841       ',C' =&gt; '&amp;#199;', <span class="comment">// LATIN CAPITAL LETTER C WITH CEDILLA</span>
02842       'E`' =&gt; '&amp;#200;', <span class="comment">// LATIN CAPITAL LETTER E WITH GRAVE</span>
02843       '`E' =&gt; '&amp;#200;', <span class="comment">// LATIN CAPITAL LETTER E WITH GRAVE</span>
02844       'E\'' =&gt; '&amp;#201;', <span class="comment">// LATIN CAPITAL LETTER E WITH ACUTE</span>
02845       <span class="charliteral">'\'</span>E' =&gt; '&amp;#201;', <span class="comment">// LATIN CAPITAL LETTER E WITH ACUTE</span>
02846       'E^' =&gt; '&amp;#202;', <span class="comment">// LATIN CAPITAL LETTER E WITH CIRCUMFLEX</span>
02847       '^E' =&gt; '&amp;#202;', <span class="comment">// LATIN CAPITAL LETTER E WITH CIRCUMFLEX</span>
02848       'E<span class="stringliteral">"' =&gt; '&amp;#203;', // LATIN CAPITAL LETTER E WITH DIAERESIS</span>
02849 <span class="stringliteral">      '"</span>E' =&gt; '&amp;#203;', <span class="comment">// LATIN CAPITAL LETTER E WITH DIAERESIS</span>
02850       'I`' =&gt; '&amp;#204;', <span class="comment">// LATIN CAPITAL LETTER I WITH GRAVE</span>
02851       '`I' =&gt; '&amp;#204;', <span class="comment">// LATIN CAPITAL LETTER I WITH GRAVE</span>
02852       'I\'' =&gt; '&amp;#205;', <span class="comment">// LATIN CAPITAL LETTER I WITH ACUTE</span>
02853       <span class="charliteral">'\'</span>I' =&gt; '&amp;#205;', <span class="comment">// LATIN CAPITAL LETTER I WITH ACUTE</span>
02854       'I^' =&gt; '&amp;#206;', <span class="comment">// LATIN CAPITAL LETTER I WITH CIRCUMFLEX</span>
02855       '^I' =&gt; '&amp;#206;', <span class="comment">// LATIN CAPITAL LETTER I WITH CIRCUMFLEX</span>
02856       'I<span class="stringliteral">"' =&gt; '&amp;#207;', // LATIN CAPITAL LETTER I WITH DIAERESIS</span>
02857 <span class="stringliteral">      '"</span>I' =&gt; '&amp;#207;', <span class="comment">// LATIN CAPITAL LETTER I WITH DIAERESIS</span>
02858       'D-' =&gt; '&amp;#208;', <span class="comment">// LATIN CAPITAL LETTER ETH</span>
02859       '-D' =&gt; '&amp;#208;', <span class="comment">// LATIN CAPITAL LETTER ETH</span>
02860       'N~' =&gt; '&amp;#209;', <span class="comment">// LATIN CAPITAL LETTER N WITH TILDE</span>
02861       '~N' =&gt; '&amp;#209;', <span class="comment">// LATIN CAPITAL LETTER N WITH TILDE</span>
02862       'O`' =&gt; '&amp;#210;', <span class="comment">// LATIN CAPITAL LETTER O WITH GRAVE</span>
02863       '`O' =&gt; '&amp;#210;', <span class="comment">// LATIN CAPITAL LETTER O WITH GRAVE</span>
02864       'O\'' =&gt; '&amp;#211;', <span class="comment">// LATIN CAPITAL LETTER O WITH ACUTE</span>
02865       <span class="charliteral">'\'</span>O' =&gt; '&amp;#211;', <span class="comment">// LATIN CAPITAL LETTER O WITH ACUTE</span>
02866       'O^' =&gt; '&amp;#212;', <span class="comment">// LATIN CAPITAL LETTER O WITH CIRCUMFLEX</span>
02867       '^O' =&gt; '&amp;#212;', <span class="comment">// LATIN CAPITAL LETTER O WITH CIRCUMFLEX</span>
02868       'O~' =&gt; '&amp;#213;', <span class="comment">// LATIN CAPITAL LETTER O WITH TILDE</span>
02869       '~O' =&gt; '&amp;#213;', <span class="comment">// LATIN CAPITAL LETTER O WITH TILDE</span>
02870       'O<span class="stringliteral">"' =&gt; '&amp;#214;', // LATIN CAPITAL LETTER O WITH DIAERESIS</span>
02871 <span class="stringliteral">      '"</span>O' =&gt; '&amp;#214;', <span class="comment">// LATIN CAPITAL LETTER O WITH DIAERESIS</span>
02872       'O/' =&gt; '&amp;#216;', <span class="comment">// LATIN CAPITAL LETTER O WITH STROKE</span>
02873       '/O' =&gt; '&amp;#216;', <span class="comment">// LATIN CAPITAL LETTER O WITH STROKE</span>
02874       'U`' =&gt;  '&amp;#217;', <span class="comment">// LATIN CAPITAL LETTER U WITH GRAVE</span>
02875       '`U' =&gt;  '&amp;#217;', <span class="comment">// LATIN CAPITAL LETTER U WITH GRAVE</span>
02876       'U\'' =&gt; '&amp;#218;', <span class="comment">// LATIN CAPITAL LETTER U WITH ACUTE</span>
02877       <span class="charliteral">'\'</span>U' =&gt; '&amp;#218;', <span class="comment">// LATIN CAPITAL LETTER U WITH ACUTE</span>
02878       'U^' =&gt; '&amp;#219;', <span class="comment">// LATIN CAPITAL LETTER U WITH CIRCUMFLEX</span>
02879       '^U' =&gt; '&amp;#219;', <span class="comment">// LATIN CAPITAL LETTER U WITH CIRCUMFLEX</span>
02880       'U<span class="stringliteral">"' =&gt; '&amp;#220;', // LATIN CAPITAL LETTER U WITH DIAERESIS</span>
02881 <span class="stringliteral">      '"</span>U' =&gt; '&amp;#220;', <span class="comment">// LATIN CAPITAL LETTER U WITH DIAERESIS</span>
02882       'Y\'' =&gt; '&amp;#221;', <span class="comment">// LATIN CAPITAL LETTER Y WITH ACUTE</span>
02883       <span class="charliteral">'\'</span>Y' =&gt; '&amp;#221;', <span class="comment">// LATIN CAPITAL LETTER Y WITH ACUTE</span>
02884       'a`' =&gt; '&amp;#224;', <span class="comment">// LATIN SMALL LETTER A WITH GRAVE</span>
02885       '`a' =&gt; '&amp;#224;', <span class="comment">// LATIN SMALL LETTER A WITH GRAVE</span>
02886       'a\'' =&gt; '&amp;#225;', <span class="comment">// LATIN SMALL LETTER A WITH ACUTE</span>
02887       <span class="charliteral">'\'</span>a' =&gt; '&amp;#225;', <span class="comment">// LATIN SMALL LETTER A WITH ACUTE</span>
02888       'a^' =&gt; '&amp;#226;', <span class="comment">// LATIN SMALL LETTER A WITH CIRCUMFLEX</span>
02889       '^a' =&gt; '&amp;#226;', <span class="comment">// LATIN SMALL LETTER A WITH CIRCUMFLEX</span>
02890       'a~' =&gt; '&amp;#227;', <span class="comment">// LATIN SMALL LETTER A WITH TILDE</span>
02891       '~a' =&gt; '&amp;#227;', <span class="comment">// LATIN SMALL LETTER A WITH TILDE</span>
02892       'a<span class="stringliteral">"' =&gt; '&amp;#228;', // LATIN SMALL LETTER A WITH DIAERESIS</span>
02893 <span class="stringliteral">      '"</span>a' =&gt; '&amp;#228;', <span class="comment">// LATIN SMALL LETTER A WITH DIAERESIS</span>
02894       'ao' =&gt; '&amp;#229;', <span class="comment">// LATIN SMALL LETTER A WITH RING ABOVE</span>
02895       'oa' =&gt; '&amp;#229;', <span class="comment">// LATIN SMALL LETTER A WITH RING ABOVE</span>
02896       'ae' =&gt; '&amp;#230;', <span class="comment">// LATIN SMALL LETTER AE</span>
02897       'c,' =&gt; '&amp;#231;', <span class="comment">// LATIN SMALL LETTER C WITH CEDILLA</span>
02898       ',c' =&gt; '&amp;#231;', <span class="comment">// LATIN SMALL LETTER C WITH CEDILLA</span>
02899       'e`' =&gt; '&amp;#232;', <span class="comment">// LATIN SMALL LETTER E WITH GRAVE</span>
02900       '`e' =&gt; '&amp;#232;', <span class="comment">// LATIN SMALL LETTER E WITH GRAVE</span>
02901       'e\'' =&gt; '&amp;#233;', <span class="comment">// LATIN SMALL LETTER E WITH ACUTE</span>
02902       <span class="charliteral">'\'</span>e' =&gt; '&amp;#233;', <span class="comment">// LATIN SMALL LETTER E WITH ACUTE</span>
02903       'e^' =&gt; '&amp;#234;', <span class="comment">// LATIN SMALL LETTER E WITH CIRCUMFLEX</span>
02904       '^e' =&gt; '&amp;#234;', <span class="comment">// LATIN SMALL LETTER E WITH CIRCUMFLEX</span>
02905       'e<span class="stringliteral">"' =&gt; '&amp;#235;', // LATIN SMALL LETTER E WITH DIAERESIS</span>
02906 <span class="stringliteral">      '"</span>e' =&gt; '&amp;#235;', <span class="comment">// LATIN SMALL LETTER E WITH DIAERESIS</span>
02907       'i`' =&gt; '&amp;#236;', <span class="comment">// LATIN SMALL LETTER I WITH GRAVE</span>
02908       '`i' =&gt; '&amp;#236;', <span class="comment">// LATIN SMALL LETTER I WITH GRAVE</span>
02909       'i\'' =&gt; '&amp;#237;', <span class="comment">// LATIN SMALL LETTER I WITH ACUTE</span>
02910       <span class="charliteral">'\'</span>i' =&gt; '&amp;#237;', <span class="comment">// LATIN SMALL LETTER I WITH ACUTE</span>
02911       'i^' =&gt; '&amp;#238;', <span class="comment">// LATIN SMALL LETTER I WITH CIRCUMFLEX</span>
02912       '^i' =&gt; '&amp;#238;', <span class="comment">// LATIN SMALL LETTER I WITH CIRCUMFLEX</span>
02913       'i<span class="stringliteral">"' =&gt; '&amp;#239;', // LATIN SMALL LETTER I WITH DIAERESIS</span>
02914 <span class="stringliteral">      '"</span>i' =&gt; '&amp;#239;', <span class="comment">// LATIN SMALL LETTER I WITH DIAERESIS</span>
02915       'n~' =&gt; '&amp;#241;', <span class="comment">// LATIN SMALL LETTER N WITH TILDE</span>
02916       '~n' =&gt; '&amp;#241;', <span class="comment">// LATIN SMALL LETTER N WITH TILDE</span>
02917       'o`' =&gt; '&amp;#242;', <span class="comment">// LATIN SMALL LETTER O WITH GRAVE</span>
02918       '`o' =&gt; '&amp;#242;', <span class="comment">// LATIN SMALL LETTER O WITH GRAVE</span>
02919       'o\'' =&gt; '&amp;#243;', <span class="comment">// LATIN SMALL LETTER O WITH ACUTE</span>
02920       <span class="charliteral">'\'</span>o' =&gt; '&amp;#243;', <span class="comment">// LATIN SMALL LETTER O WITH ACUTE</span>
02921       'o^' =&gt; '&amp;#244;', <span class="comment">// LATIN SMALL LETTER O WITH CIRCUMFLEX</span>
02922       '^o' =&gt; '&amp;#244;', <span class="comment">// LATIN SMALL LETTER O WITH CIRCUMFLEX</span>
02923       'o~' =&gt; '&amp;#245;', <span class="comment">// LATIN SMALL LETTER O WITH TILDE</span>
02924       '~o' =&gt; '&amp;#245;', <span class="comment">// LATIN SMALL LETTER O WITH TILDE</span>
02925       'o<span class="stringliteral">"' =&gt; '&amp;#246;', // LATIN SMALL LETTER O WITH DIAERESIS</span>
02926 <span class="stringliteral">      '"</span>o' =&gt; '&amp;#246;', <span class="comment">// LATIN SMALL LETTER O WITH DIAERESIS</span>
02927       ':-' =&gt; '&amp;#247;', <span class="comment">// DIVISION SIGN</span>
02928       '-:' =&gt; '&amp;#247;', <span class="comment">// DIVISION SIGN</span>
02929       'o/' =&gt; '&amp;#248;', <span class="comment">// LATIN SMALL LETTER O WITH STROKE</span>
02930       '/o' =&gt; '&amp;#248;', <span class="comment">// LATIN SMALL LETTER O WITH STROKE</span>
02931       'u`' =&gt; '&amp;#249;', <span class="comment">// LATIN SMALL LETTER U WITH GRAVE</span>
02932       '`u' =&gt; '&amp;#249;', <span class="comment">// LATIN SMALL LETTER U WITH GRAVE</span>
02933       'u\'' =&gt; '&amp;#250;', <span class="comment">// LATIN SMALL LETTER U WITH ACUTE</span>
02934       <span class="charliteral">'\'</span>u' =&gt; '&amp;#250;', <span class="comment">// LATIN SMALL LETTER U WITH ACUTE</span>
02935       'u^' =&gt; '&amp;#251;', <span class="comment">// LATIN SMALL LETTER U WITH CIRCUMFLEX</span>
02936       '^u' =&gt; '&amp;#251;', <span class="comment">// LATIN SMALL LETTER U WITH CIRCUMFLEX</span>
02937       'u<span class="stringliteral">"' =&gt; '&amp;#252;', // LATIN SMALL LETTER U WITH DIAERESIS</span>
02938 <span class="stringliteral">      '"</span>u' =&gt; '&amp;#252;', <span class="comment">// LATIN SMALL LETTER U WITH DIAERESIS</span>
02939       'y\'' =&gt; '&amp;#253;', <span class="comment">// LATIN SMALL LETTER Y WITH ACUTE</span>
02940       <span class="charliteral">'\'</span>y' =&gt; '&amp;#253;', <span class="comment">// LATIN SMALL LETTER Y WITH ACUTE</span>
02941       'y<span class="stringliteral">"' =&gt; '&amp;#255;', // LATIN SMALL LETTER Y WITH DIAERESIS</span>
02942 <span class="stringliteral">      '"</span>y' =&gt; '&amp;#255;', <span class="comment">// LATIN SMALL LETTER Y WITH DIAERESIS</span>
02943       'OE' =&gt; '&amp;#338;', <span class="comment">// LATIN CAPITAL LIGATURE OE</span>
02944       'oe' =&gt; '&amp;#339;', <span class="comment">// LATIN SMALL LIGATURE OE</span>
02945       <span class="charliteral">'*'</span> =&gt; '&amp;#8226;', <span class="comment">// BULLET</span>
02946       'Fr' =&gt; '&amp;#8355;', <span class="comment">// FRENCH FRANC SIGN</span>
02947       'L=' =&gt; '&amp;#8356;', <span class="comment">// LIRA SIGN</span>
02948       '=L' =&gt; '&amp;#8356;', <span class="comment">// LIRA SIGN</span>
02949       'Rs' =&gt; '&amp;#8360;', <span class="comment">// RUPEE SIGN</span>
02950       'C=' =&gt; '&amp;#8364;', <span class="comment">// EURO SIGN</span>
02951       '=C' =&gt; '&amp;#8364;', <span class="comment">// EURO SIGN</span>
02952       'tm' =&gt; '&amp;#8482;', <span class="comment">// TRADE MARK SIGN</span>
02953       '&amp;lt;-' =&gt; '&amp;#8592;', <span class="comment">// LEFTWARDS ARROW</span>
02954       '-&amp;gt;' =&gt; '&amp;#8594;', <span class="comment">// RIGHTWARDS ARROW</span>
02955       '&amp;lt;=' =&gt; '&amp;#8656;', <span class="comment">// LEFTWARDS DOUBLE ARROW</span>
02956       '=&amp;gt;' =&gt; '&amp;#8658;', <span class="comment">// RIGHTWARDS DOUBLE ARROW</span>
02957       '=/' =&gt; '&amp;#8800;', <span class="comment">// NOT EQUAL TO</span>
02958       '/=' =&gt; '&amp;#8800;', <span class="comment">// NOT EQUAL TO</span>
02959       '&amp;lt;_' =&gt; '&amp;#8804;', <span class="comment">// LESS-THAN OR EQUAL TO</span>
02960       '_&amp;lt;' =&gt; '&amp;#8804;', <span class="comment">// LESS-THAN OR EQUAL TO</span>
02961       '&amp;gt;_' =&gt; '&amp;#8805;', <span class="comment">// GREATER-THAN OR EQUAL TO</span>
02962       '_&amp;gt;' =&gt; '&amp;#8805;', <span class="comment">// GREATER-THAN OR EQUAL TO</span>
02963       ':(' =&gt; '&amp;#9785;', <span class="comment">// WHITE FROWNING FACE</span>
02964       ':)' =&gt; '&amp;#9786;', <span class="comment">// WHITE SMILING FACE</span>
02965       'spade' =&gt; '&amp;#9824;', <span class="comment">// BLACK SPADE SUIT</span>
02966       'club' =&gt; '&amp;#9827;', <span class="comment">// BLACK CLUB SUIT</span>
02967       'heart' =&gt; '&amp;#9829;', <span class="comment">// BLACK HEART SUIT</span>
02968       'diamond' =&gt; '&amp;#9830;', <span class="comment">// BLACK DIAMOND SUIT</span>
02969     );
02970   } <span class="comment">// function default_macros</span>
02971 
02972   <span class="comment">// "private", internal routines</span>
02973 
<a name="l02980"></a><a class="code" href="classTextile.html#d26">02980</a>   function _css_defaults() {
02981     $css_defaults = array(
02982       'class_align_right' =&gt; 'right',
02983       'class_align_left' =&gt; 'left',
02984       'class_align_center' =&gt; 'center',
02985       'class_align_top' =&gt; 'top',
02986       'class_align_bottom' =&gt; 'bottom',
02987       'class_align_middle' =&gt; 'middle',
02988       'class_align_justify' =&gt; 'justify',
02989       'class_caps' =&gt; 'caps',
02990       'class_footnote' =&gt; 'footnote',
02991       'id_footnote_prefix' =&gt; 'fn',
02992     );
02993     $this-&gt;css($css_defaults);
02994   } <span class="comment">// function _css_defaults</span>
02995 
<a name="l03025"></a><a class="code" href="classTextile.html#d27">03025</a>   function _halign($align) {
03026     <span class="keywordflow">if</span> (preg_match('/&lt;&gt;/', $align)) {
03027       <span class="keywordflow">return</span> 'justify';
03028     } elseif (preg_match('/&lt;/', $align)) {
03029       <span class="keywordflow">return</span> 'left';
03030     } elseif (preg_match('/&gt;/', $align)) {
03031       <span class="keywordflow">return</span> 'right';
03032     } elseif (preg_match('/=/', $align)) {
03033       <span class="keywordflow">return</span> 'center';
03034     }
03035     <span class="keywordflow">return</span> '';
03036   } <span class="comment">// function _halign</span>
03037 
<a name="l03063"></a><a class="code" href="classTextile.html#d28">03063</a>   function _valign($align) {
03064     <span class="keywordflow">if</span> (preg_match('/\^/', $align)) {
03065       <span class="keywordflow">return</span> 'top';
03066     } elseif (preg_match('/~/', $align)) {
03067       <span class="keywordflow">return</span> 'bottom';
03068     } elseif (preg_match('/-/', $align)) {
03069       <span class="keywordflow">return</span> 'middle';
03070     }
03071     <span class="keywordflow">return</span> '';
03072   } <span class="comment">// function _valign</span>
03073 
<a name="l03109"></a><a class="code" href="classTextile.html#d29">03109</a>   function _imgalign($align) {
03110     $align = preg_replace('/(&lt;&gt;|=)/', '', $align);
03111     <span class="keywordflow">return</span> ($this-&gt;_valign($align) ? $this-&gt;_valign($align) : $this-&gt;_halign($align));
03112   } <span class="comment">// function _imgalign</span>
03113 
<a name="l03130"></a><a class="code" href="classTextile.html#d30">03130</a>   function _strip_borders(&amp;$pre, &amp;$post) {
03131     <span class="keywordflow">if</span> ($post &amp;&amp; $pre &amp;&amp; preg_match('/[{[]/', ($open = substr($pre, 0, 1)))) {
03132       $close = substr($post, 0, 1);
03133       <span class="keywordflow">if</span> ((($open == <span class="charliteral">'{'</span>) &amp;&amp; ($close == <span class="charliteral">'}'</span>)) ||
03134           (($open == <span class="charliteral">'['</span>) &amp;&amp; ($close == <span class="charliteral">']'</span>))) {
03135         $pre = substr($pre, 1);
03136         $post = substr($post, 1);
03137       } <span class="keywordflow">else</span> {
03138         <span class="keywordflow">if</span> (!preg_match('/[}\]]/', $close)) { $close = substr($post, -1, 1); }
03139         <span class="keywordflow">if</span> ((($open == <span class="charliteral">'{'</span>) &amp;&amp; ($close == <span class="charliteral">'}'</span>)) ||
03140             (($open == <span class="charliteral">'['</span>) &amp;&amp; ($close == <span class="charliteral">']'</span>))) {
03141           $pre = substr($pre, 1);
03142           $post = substr($post, 0, strlen($post) - 1);
03143         }
03144       }
03145     }
03146   } <span class="comment">// function _strip_borders</span>
03147 
<a name="l03162"></a><a class="code" href="classTextile.html#d31">03162</a>   function _repl(&amp;$array, $str) {
03163     $array[] = $str;
03164     <span class="keywordflow">return</span> '&lt;textile#' . count($array) . <span class="charliteral">'&gt;'</span>;
03165   } <span class="comment">// function _repl</span>
03166 
<a name="l03177"></a><a class="code" href="classTextile.html#d32">03177</a>   function _tokenize($str) {
03178     $pos = 0;
03179     $len = strlen($str);
03180     unset($tokens);
03181 
03182     $depth = 6;
03183     $nested_tags = substr(str_repeat('(?:&lt;/?[A-Za-z0-9:]+ \s? (?:[^&lt;&gt;]|', $depth), 0, -1)
03184       . str_repeat(')*&gt;)', $depth);
03185     $match = '(?s: &lt;! ( -- .*? -- \s* )+ &gt; )|  # comment
03186               (?s: &lt;\? .*? \?&gt; )|              # processing instruction
03187               (?s: &lt;% .*? %&gt; )|                # ASP-like
03188               (?:' . $nested_tags . ')|
03189               (?:' . $this-&gt;codere . <span class="charliteral">')'</span>;     <span class="comment">// nested tags</span>
03190 
03191     <span class="keywordflow">while</span> (preg_match('{(' . $match . ')}x', substr($str, $pos), $matches, PREG_OFFSET_CAPTURE)) {
03192       $whole_tag = $matches[1][0];
03193       $sec_start = $pos + $matches[1][1] + strlen($whole_tag);
03194       $tag_start = $sec_start - strlen($whole_tag);
03195       <span class="keywordflow">if</span> ($pos &lt; $tag_start) {
03196         $tokens[] = array('text', substr($str, $pos, $tag_start - $pos));
03197       }
03198       <span class="keywordflow">if</span> (preg_match('/^[[{]?@/', $whole_tag)) {
03199         $tokens[] = array('text', $whole_tag);
03200       } <span class="keywordflow">else</span> {
03201         <span class="comment">// this clever hack allows us to preserve \n within tags.</span>
03202         <span class="comment">// this is restored at the end of the format_paragraph method</span>
03203         <span class="comment">//$whole_tag = preg_replace('/\n/', "\r", $whole_tag);</span>
03204         $whole_tag = preg_replace('/\n/', <span class="stringliteral">"\001"</span>, $whole_tag);
03205         $tokens[] = array('tag', $whole_tag);
03206       }
03207       $pos = $sec_start;
03208     }
03209     <span class="keywordflow">if</span> ($pos &lt; $len) { $tokens[] = array('text', substr($str, $pos, $len - $pos)); }
03210     <span class="keywordflow">return</span> $tokens;
03211   } <span class="comment">// function _tokenize</span>
03212 
<a name="l03221"></a><a class="code" href="classTextile.html#e0">03221</a>   function version() {
03222     <span class="comment">/* Why text and an ID?  Well, the text is easier for the user to</span>
03223 <span class="comment">     * read and understand while the build ID, being a number (a date</span>
03224 <span class="comment">     * with a serial, specifically), is easier for the developer to</span>
03225 <span class="comment">     * use to determine newer/older versions for upgrade and</span>
03226 <span class="comment">     * installation purposes.</span>
03227 <span class="comment">     */</span>
03228     <span class="keywordflow">return</span> array(<span class="stringliteral">"text"</span> =&gt; <span class="stringliteral">"2.0.4"</span>, <span class="stringliteral">"build"</span> =&gt; 2004072800);
03229   } <span class="comment">// function version</span>
03230 
<a name="l03243"></a><a class="code" href="classTextile.html#d33">03243</a>   function _cb($function) {
03244     $current =&amp; <a class="code" href="classTextile.html#h0">Textile::_current_store</a>($<span class="keyword">this</span>);
03245     <span class="keywordflow">return</span> create_function('$m', '$me =&amp; <a class="code" href="classTextile.html#h1">Textile::_current</a>(); <span class="keywordflow">return</span> ' . $function . <span class="charliteral">';'</span>);
03246   } <span class="comment">// function _cb</span>
03247 
<a name="l03263"></a><a class="code" href="classTextile.html#h0">03263</a>  <span class="comment">/* static */</span> function &amp;_current_store(&amp;$<span class="keyword">new</span>) {
03264    <span class="keyword">static</span> $current = array();
03265 
03266    <span class="keywordflow">if</span> ($new != NULL) {
03267      $current = array(&amp;$<span class="keyword">new</span>);
03268    }
03269 
03270    <span class="keywordflow">return</span> $current;
03271  } <span class="comment">// function _current_store</span>
03272 
<a name="l03283"></a><a class="code" href="classTextile.html#h1">03283</a>  <span class="comment">/* static */</span> function &amp;_current() {
03284    $current =&amp; <a class="code" href="classTextile.html#h0">Textile::_current_store</a>($null = NULL);
03285    <span class="keywordflow">return</span> $current[0];
03286  } <span class="comment">// function _current</span>
03287 } <span class="comment">// class Textile</span>
03288 
<a name="l03337"></a><a class="code" href="classMTLikeTextile.html">03337</a> <span class="keyword">class </span><a class="code" href="classMTLikeTextile.html">MTLikeTextile</a> <span class="keyword">extends</span> <a class="code" href="classTextile.html">Textile</a> {
<a name="l03349"></a><a class="code" href="classMTLikeTextile.html#a0">03349</a>   function <a class="code" href="classMTLikeTextile.html">MTLikeTextile</a>($options = array()) {
03350     parent::Textile($options);
03351   } <span class="comment">// function MTLikeTextile</span>
03352 
<a name="l03356"></a><a class="code" href="classMTLikeTextile.html#d0">03356</a>   function <a class="code" href="classMTLikeTextile.html#d0">process_quotes</a>($str) {
03357     <span class="keywordflow">if</span> (!$this-&gt;options['do_quotes'] || !function_exists('SmartyPants')) {
03358       <span class="keywordflow">return</span> $str;
03359     }
03360 
03361     <span class="keywordflow">return</span> SmartyPants($str, $this-&gt;options['smarty_mode']);
03362   } <span class="comment">// function process_quotes</span>
03363 
<a name="l03367"></a><a class="code" href="classMTLikeTextile.html#d1">03367</a>   function <a class="code" href="classMTLikeTextile.html#d1">format_url</a>($args) {
03368     $url = ($args['url'] ? $args['url'] : '');
03369 
03370     <span class="keywordflow">if</span> (preg_match('/^(imdb|google|dict|amazon)(:(.+))?$/x', $url, $matches)) {
03371       $term = $matches[3];
03372       $term = ($term ? $term : strip_tags($args['linktext']));
03373 
03374       <span class="keywordflow">switch</span> ($matches[1]) {
03375         <span class="keywordflow">case</span> 'imdb':
03376           $args['url'] = 'http:<span class="comment">//www.imdb.com/Find?for=' . $term;</span>
03377           <span class="keywordflow">break</span>;
03378 
03379         <span class="keywordflow">case</span> 'google':
03380           $args['url'] = 'http:<span class="comment">//www.google.com/search?q=' . $term;</span>
03381           <span class="keywordflow">break</span>;
03382 
03383         <span class="keywordflow">case</span> 'dict':
03384           $args['url'] = 'http:<span class="comment">//www.dictionary.com/search?q=' . $term;</span>
03385           <span class="keywordflow">break</span>;
03386 
03387         <span class="keywordflow">case</span> 'amazon':
03388           $args['url'] = 'http:<span class="comment">//www.amazon.com/exec/obidos/external-search?index=blended&amp;keyword=' . $term;</span>
03389           <span class="keywordflow">break</span>;
03390       }
03391     }
03392 
03393     <span class="keywordflow">return</span> parent::format_url($args);
03394   } <span class="comment">// function format_url</span>
03395 } <span class="comment">// class MTLikeTextile</span>
03396 
04080 ?&gt;
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Wed Jul 28 10:44:32 2004 for TextilePHP by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
